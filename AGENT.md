# アプリケーション仕様書

## 1. プロジェクト概要

### 1.1. 概要
本アプリケーションは、仕様書／設計書／議事録等（テキスト化済み）の非構造化情報を「カード」に分割・構造化し、編集・管理・トレーサビリティを可能にする。
- 自然言語の設計文書を構造化データとして管理する。
- 構造化した各文書間でトレーサビリティを確保する。
- 原文書の変更に追従して管理情報を更新する。

入力（`.txt`, `.md`）を意味単位の「カード」に分割し、カード内容・順序・階層・関係（トレーサビリティ）を編集可能にし、JSONで保存する。

本アプリは次の2機能から成る。
1. カード変換機能: テキストから「カード」を生成
2. カード編集機能: カード内容・順序・階層・関係（トレーサビリティ）の編集

UIの操作性・拡張性とデータ保護の観点から、Electron/React/TypeScript によるデスクトップアプリとして実装する。

### 1.2. 目的と開発意義
既存の大規模PJでは、設計情報が自然言語文書で散在・連携は人手依存であり、生成AIの適用範囲がコード周辺に限定されがちである。本アプリにより、
- 仕様／設計／設計経緯の非構造化→構造化データ変換
- デジタル空間での情報連携（トレーサビリティ）
を推進し、生成AI活用の適用範囲を上流工程に拡張する。

## 2. 共通機能

### 2.1. 機能要件

#### 2.1.1. ファイル
- パラメータファイル
  - ファイル名: `setting_params.json`
  - 目的: アプリの各種設定を管理
- 入力ファイル
  - 対応拡張子: `.txt`, `.md`
  - 文字コード: UTF-8（BOM有無どちらも可）。CP932/SJISは自動判別してUTF-8に変換。その他はエラー。
  - 改行: `\n`/`\r\n` を許容し、内部では正規化する。
  - サイズ: 制限は設けないが、10MB超は警告、50MB超は確認ダイアログ表示。
  - 内容: 仕様／設計／設計経緯などのテキスト情報（画像は対象外）。
- カードファイル（旧: チャンクドファイル）
  - ファイル名: `<input_basename>_<label>.json`
  - 目的: 構造化されたカード情報を保持（JSON）
- トレース管理ファイル
  - ファイル名: `trace_<left_basename>_<right_basename>.json`
  - 目的: 2つのカードファイル間のトレーサビリティ情報を保持（JSON）
- 動作ログファイル
  - ファイル名: `YYYYMMDD_hhmmss.log`
  - 目的: アプリの動作ログを保存

##### 2.1.1.1 パラメータファイル項目
- 出力/ログ
  - `outDir`: カードファイル/トレース管理ファイルの出力先（既定: `./_out/`）
  - `logDir`: ログ出力先（既定: `./_logs/`）
  - `logLevel`: `info|warn|error|debug`（既定: `info`）
  - `logRotation`: `{ maxFileSizeMB, maxFiles, retentionDays }`
- 入力
  - `maxWarnSizeMB`（既定: 10）, `maxConfirmSizeMB`（既定: 50）
- 変換（Strategy設定）
  - `converter.strategy`: `blanklines|markdown|numbering|indent|llm`
  - `converter.priority`: 例 `['markdown','numbering','indent','blanklines']`
- LLM
  - `llm.provider`: `openai|gemini|ollama|none`
  - `llm.model`, `llm.temperature`（既定: 0）, `llm.maxTokens`
  - `llm.allowCloud`: `true|false`（既定: `false`）
  - `llm.redaction.enabled`: `true|false`（固有名詞/数値の匿名化）

##### 2.1.1.2 入力ファイル
- 本アプリの入力ソース。読み込み時にエンコーディングを判別し、内部表現へ正規化する。

##### 2.1.1.3 カードファイル
- JSON構造は 5章のデータモデルに準拠。最低限含むもの:
  - `schemaVersion`（例: `1`）
  - `updatedAt`（ISO 8601）
  - `source`: 読み込み元ファイル情報の要約
  - `cards[]`: カード配列（5.1参照）

##### 2.1.1.4 トレース管理ファイル
- 2つのカードファイル間の関係を保持。左右は識別子であり上下関係の意味は持たない。
- JSON構造（5.3参照）:
  - `left_file`, `right_file`
  - `relations[]`: `{ left_ids[], right_ids[], type, directed, memo }`
  - `directed`: `left_to_right|right_to_left|bidirectional`
  - `type`: `trace|refines|tests|duplicates`（将来拡張可）

##### 2.1.1.5 動作ログファイル
- 発生時刻、ログレベル、メッセージ、スタック情報（あれば）を出力。レベルは `info|warn|error|debug`。


#### 2.1.2 UI/UX仕様

##### 2.1.2.1 全体レイアウト
  - **ツールバー（2段構成）**:
    1.  **上段**: メニューバー。
        1.  ファイル操作(F)(アプリケーションの終了)
        2.  ヘルプ(H)(操作ヘルプ画面、バージョン情報)
    2.  **下段**: 機能別画面をタブで選択切り替えできるようにする。
        1.  カード変換機能
        2.  カード編集機能
  - **メインエリア**:<機能別画面>
  - **フッター**: リサイズ可能なステータスログパネル

##### 2.1.2.2 カード変換画面
- **レイアウト**:
  - **ツールバー（2段構成）**:
      1.  **上段**: 
      以下を左から順に表示する。
        - アイコン（テキスト(txt,md)開く、JSON名前を付けて保存、新規作成）。- 現在開いているJSONファイル名
      2.  **下段**: 
      以下を左から順に表示
        - 階層折畳/展開操作のトグルスイッチ
  - **タブエリア**:
    - タブで、**カード表示エリア**の情報を切り替えられるようにする。
    - タブには、ファイル名を表示する。
    - タブの高さの目安は 32px、最小幅 160px。幅は可変で、表示エリアを優先する。
  - **カード表示エリア**:
    - ファイルを開いていない状態では、エリアへドラッグアンドドロップでテキストを開く。
    - 変換結果のカードリストパネル(##### 2.1.2.4 カードリストパネル)を表示する。

##### 2.1.2.3 カード編集画面
- **レイアウト**:
  - **ツールバー（2段構成）**:
      1.  **上段**: 
      以下を左から順に表示する。
        - アイコン（チャンクドファイル(json)の開く、上書き保存、名前を付けて保存、トレース情報保存）。未保存の場合は、その状態が視覚的にわかるようにする。
        - 現在開いているJSONファイル名
      2.  **下段**: 
      以下を左から順に表示
        - 操作戻る
        - 操作進む
        - カーソルがいるアクティブパネルに対して、階層折畳/展開操作のトグルスイッチ
        - カード表示エリアの全てのパネルに対して、階層折畳/展開操作のトグルスイッチ
        - トレーサビリティのコネクタ表示有無のトグルスイッチ
        - トレース強調表示有無のトグルスイッチ
        - カードの状態のフィルタ表示(`TODO`,`DOING`,`COMPLETE`)
  - **タブエリア**:
    - タブで、**カード表示エリア**の情報を切り替えられるようにする。
    - タブには、ファイル名を表示する。
    - タブの横幅は固定、高さは**カード表示エリア**に十分な高さを確保できるように、低めに設定する。
  - **カード表示エリア**:
    - 変換結果のカードリストパネル(##### 2.1.2.4 カードリストパネル)を表示する。
    - カード表示エリアは水平・垂直方向へ任意に分割可能とする。分割した一つのエリアをパネルと称する。
    - カードリストパネルに、まだチャンクドファイルの情報が読み込まれていない場合、ドラッグアンドドロップでチャンクドファイルをオープンする。
    - 同じカードファイルを、複数のパネルに配置可能（制限なし）。
    - 1パネルは1カードファイルに対応。他タブ/他パネルで同一カードファイルが更新された場合は即時反映する。

    - 隣り合った左右のパネルの各カード間のトレーサビリティ情報を、視覚でわかるようにコネクタで接続した表示を行う。
    - コネクタ(トレーサビリティ情報)をUI上から操作（作成、変更、削除）可能とする。
    - コネクタは有向性を矢印で表現（片方向/双方向/方向なし）。
    - コネクタのスタイルはカスタマイズ可能（有向/色/太さ/実線・破線・点線/コネクタ上のテキスト有無）。

##### 2.1.2.4 カードリストパネル
- **カードリスト表示仕様**
縦／横スクロールで全カード情報を参照可能とする。
  - **階層表示**: カードは親子関係を持つ。子レベル(=階層レベル)応じてに右側に一段下げた表示とする。
  - **階層折畳**: 指定したレベル以下を折畳／展開の表示操作ができる。折畳/展開状態がわかる視覚表現をする。

- **カード個別表示仕様**
  - **高さ**: カードの高さは、表示内容がすべて収まるように自動で調整する。
  - **横幅**: カードの横幅は、最上位階層のカードの表示内容がすべて収まるように、画面サイズにより自動で調整する。2階層以降は横スクロールで表示できれば良い。
  - **選択中表示**: 選択中は、カード枠色を**color=赤,太枠**でハイライト表示する。
  - **編集保存状態表示**: 編集後に未保存状態の場合、編集したカード枠色を**color=橙**でハイライト表示、保存済みは**color=黒**。

  - **表示レイアウト**:
    - 以下の**表示部品**を表示する。
    - 1段目: **タイトル**、**カード情報種別**
    - 2段目: **カード情報本文**

    - **表示部品**:
      - **タイトル**: `content.number`を表示する。`content.number`が空or存在しなければ、`content.text`を表示する。
      - **カード情報種別**: 以下の種別をドロップダウンリストで表示する。
        - 見出し
        - 本文(デフォルト)
        - 図
        - 表
        - 試験
        - QA
        - メモ
      - **カードの状態**: `TODO`,`DOING`,`COMPLETE`。
      - **カード情報本文**: 本文`content`を表示する。
      - **比較状態**: カードの状態`status`ごとに色分けし、視覚的に識別可能とする。

  - **個別折畳/展開時の表示**:
    - 1. 折畳時: 表示レイアウトの1段目のみを表示
    - 2. 展開時: 表示レイアウトの全段を表示

- **カードの操作性**:
  - **複数選択**: 
    - **離散複数選択**: CTRLを押した状態の場合、同一階層の複数のカードを選択可能とする。カード位置は連続している必要はない。
    - **連続複数選択**: CTRLを押した状態の場合、連続した同一階層の複数のカードを選択可能とする。

  - **移動**: ドラッグアンドドロップで表示位置（順序、階層レベル）を変更可能。移動先（=カード間の位置）をハイライトする。
    - **下位階層**: 自分より下位階層のカードについては、階層構造を維持してすべて移動する。
    - **複数選択**: **離散複数選択**または**連続複数選択**している状態で移動に対応する。

  - **編集**: カード情報種別、カードの状態、カード情報本文を編集可能とする。
    - **複数選択**: 複数選択状態の場合、カード状態種別`type`とカードの状態`status`を選択中のカードに対して同時に編集可能とする。

- **トレーサビリティ表示**: 
  - 他パネルとのコネクタ接合点が視覚的にわかるように。接合点からドラッグして、別パネルのカードの接合点に移動させることで、コネクタの接合（＝トレーサビリティ情報の作成）が可能。
  - 他パネルで選択中のカードと関係にあるカード/コネクタは、強調表示（例: **color=赤,点線枠**）。トグルでON/OFF可能。
  - 他パネルで選択中のカードに対し、レーサビリティ関係にあるカードとコネクタに対しては、線色を**color=赤,点線枠**でハイライト表示する。この機能はトレース強調表示有無のトグルスイッチで有効無効を切り替え可能とする。

## 3. カード変換機能

### 3.1. 機能要件

- **入力仕様**:
  - テキスト（`.txt`, `.md`）。UTF-8を既定。SJIS/CP932は自動変換。
  - 10MB超は警告。50MB超は確認ダイアログ。

- **変換仕様**:
  - Strategyパターンで分割/階層化をモジュール化し、設定で切替可能。
  - 共通ルール
    - 空行のみ段落は除外。段落先頭末尾の空白は除去。
    - 作成するカードは原順序を保持。タイトル推定は `content.number` → `content.text` の優先で採用。
  - 階層付与の優先度（既定）
    1) Markdown見出し(`#..######`)
    2) 番号体系（`1.`, `(1)`, `1.1` などの定義済みパターン）
    3) 字下げ（先頭スペース/タブ幅）
    4) 連続改行（段落単位のフラット）

    - 連続改行分割: `\n\n` を区切りに段落化。
 
    - LLM分割: LLM（OpenAI/Gemini/Ollama）により論理段落に分割。`temperature=0` を既定（冪等性確保）。`allowCloud=false` で外部送信禁止を既定。

  - 図情報抽出:
    - 入力がテキストに図表現（PlantUML等）を含む場合は `content.text` に保持。画像ファイルの解析はスコープ外。
    - 図番号があれば `content.number` に保持。

  - 表情報抽出:
    - Markdown表に正規化して `content.text` へ。表番号があれば `content.number` に保持。注記・説明も `content.text` に含める。

- **出力仕様**:
  - カードファイル（JSON）として保存（5.1準拠）。

- **動作ログ仕様**:
  - 変換処理開始/終了/警告/エラーを記録。LLM使用時はプロバイダとトークン概数を匿名で記録。

### 3.2. 非機能要件
 - 変換処理中も他タブ/カード編集操作を可能にする（非同期処理）。
 - 変換処理はキャンセル可能。中断時は部分結果をロールバック。
 - 異常発生時は最前面ダイアログで通知し、ログに詳細を記録。


## 4. カード編集機能

### 4.1 機能要件
- **内部の情報管理方法**:
  - 各「カード」オブジェクトは階層関係(親子関係)、順序関係(兄弟関係における順序性)をリスト構造として管理する。
  - これらの情報は、ファイル読み込み時にメモリへ読み込んでおく。
  - 複数パネル/タブで同一ファイルが開かれても、単一のインメモリ情報を共有し、操作反映は即時に同期する。
  - 外部でファイル変更があった場合は検知し、再読込/マージの確認ダイアログを表示する。

- **ユーザ操作への対応**:
  - 階層関係と順序関係はユーザ操作で編集可能とする。
  - 新規の「カード」オブジェクトを、リスト中の任意の位置に追加可能とする。
  - 任意の「カード」オブジェクトを削除可能とする。
  - 「カード」オブジェクトの階層や位置を移動可能とする。
  - 画面上からの編集操作により、「カード」オブジェクトの情報を更新可能とする。
  - ユーザの保存操作で、メモリ上の情報をJSON形式でファイル更新する。
  - 未保存変更の自動保存（オプション、間隔設定）を提供。終了/タブクローズ時は確認ダイアログ。
  - 
- **トレーサビリティ情報の管理**:
  - 隣り合うパネルに読み込まれたファイルに対して、トレーサビリティ情報を管理する。
  - 2ファイル間のトレース管理ファイルが存在しない場合、1件以上のトレース情報が作られている状態でトレース情報保存した場合に、トレース管理情報ファイルを作成する。
  - 2ファイル間でトレース管理ファイルが存在する場合、隣り合うパネルに読み込まれた時点でトレース情報を表示する(トレーサビリティのコネクタ表示有無のトグルスイッチがONに設定されている場合)
  - `relations[].type` は `trace|refines|tests|duplicates` を想定（将来拡張）。多対多を許容する。
  - `directed` はモデル（データ）側の属性であり、UIはモデルの状態を忠実に表示する。

### 4.2 非機能要件
- 性能要件:
  - 最大カード数: 10,000件を快適に操作可能。
  - 表示応答性: 仮想スクロール（`VariableSizeList`）で100ms以内の表示更新。
  - 起動/初回読込: < 2s（1,000カード）、< 8s（10,000カード）を目安。
  - 保存時間: 5,000カードで < 1s を目安。
  - メモリ: 1,000カードで < 200MB を目安。

### 4.3 Undo/Redo
- コマンド単位で履歴管理。履歴深度の目安は 1,000。
- スコープはアクティブパネルのカードファイル。保存/読み込みは履歴対象外。

### 5. データモデル仕様

#### 5.1. カードオブジェクト
以下の情報を持つ。
- `id`: カードの一意な識別子（UUID v4 文字列）
- `type`:カード情報種別
- `content`: 情報内容
  - `text`: テキスト情報(カード情報種別により、見出し内容、本文内容、図のテキスト表記、表のテキスト表記、試験手順と規格、質疑応答、議事録内容等として使用される)
  - `number`: 番号（カード情報種別により、図番号、表番号、試験番号などとして使用される。`図xx.xx`や`xxxxxxxx`等。）
- `updatedAt`: カード内容の最終更新時刻（ISO 8601）
- `status`: カードの状態（`TODO`, `DOING`, `COMPLETE`）
- `statusUpdatedAt`: カード状態の最終更新時刻（初期の「未処理」状態では空）

- `parent_id`:親カードID
- `child_ids[]`:子カードIDリスト
- `prev_id`:兄弟(同一階層)の前のカードID
- `next_id`:兄弟(同一階層)の次のカードID

備考: 木構造は `parent_id`/`child_ids[]` を正とし、`prev_id`/`next_id` は描画最適化用の派生情報（保存省略可）。

#### 5.2. 入力ファイルオブジェクト
以下の情報を持つ。
- `id`: 一意な識別子
- `fileName`: ファイル名
- `filePath`: ファイルの絶対パス
- `createdAt`: 読込時刻
- `memo`: 任意記述

#### 5.3. トレーサビリティ情報
以下の情報を持つ。
- `left_file`: カードファイル名
- `right_file`: カードファイル名
- `relations[]`:
  - `left_ids[]`: `left_file`のカードID
  - `right_ids[]`: `right_file`のカードID
  - `type`: 関係性（`trace|refines|tests|duplicates`）。既定は`trace`。
  - `directed`: `left_to_right|right_to_left|bidirectional`
  - `memo`: 任意記述

##### 5.4. JSONサンプル（抜粋）
- カードファイル
```
{
  "schemaVersion": 1,
  "updatedAt": "2025-01-01T12:00:00Z",
  "source": {"fileName": "spec.md", "filePath": "/abs/spec.md"},
  "cards": [
    {"id": "...uuid...", "type": "見出し", "content": {"text": "概要", "number": "1"}, "status": "TODO", "parent_id": null, "child_ids": []}
  ]
}
```
- トレース管理ファイル
```
{
  "left_file": "spec_v1.json",
  "right_file": "spec_v2.json",
  "relations": [
    {"left_ids": ["id1"], "right_ids": ["id9"], "type": "trace", "directed": "bidirectional"}
  ]
}
```

### 6. 技術スタック
- **技術スタック**: Electron / React / TypeScript

## 7. 開発情報

### 7.1. 開発コマンド
- `npm install`: 依存関係のインストール
- `npm start`: 開発サーバー起動
- `npm run build`: プロダクションビルド
- `npm run electron`: Electronアプリ起動
- `npm test`: テスト実行


### 7.2. 改修時のルール
- 変更を行った場合は、ドキュメント（本ファイルなど）も併せてメンテナンスする。
- コミットメッセージは日本語で行う。

## 8. セキュリティ/プライバシー
- 既定でクラウドLLMへの送信は無効（`llm.allowCloud=false`）。
- 許可時は対象範囲・匿名化（`llm.redaction`）・監査ログを必須とする。

## 9. 配布/アップデート
- 配布対象: Windows/macOS/Linux（Electron Builder想定）
- コード署名の要否と証明書取り扱いは別紙運用設計に従う。
- 自動アップデート（autoUpdater）採用の有無は将来検討とし、本仕様のスコープ外。
