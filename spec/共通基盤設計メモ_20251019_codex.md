# 共通基盤設計メモ (2025-10-19 Codex)

## 1. 目的
フェーズP2における設定管理・ログ管理・ファイルI/O土台の設計方針を整理し、実装スコープを明確化する。

## 2. 設定管理 (T2-1)
- **設定ファイル**: `settings.json` を `config/` ディレクトリ配下に配置。Electronの `app.getPath("userData")/config/settings.json` を既定とする。
- **既定値**: `src/shared/settings/defaultSettings.ts` で定義し、破損時/未存在時は既定値で再生成。
- **ロード方式**: アプリ起動時に同期ロードし、`SettingsStore` クラスで保持。JSONスキーマはZodでバリデーション。
- **更新フロー**:
  1. レンダラからIPCで更新リクエスト (`settings:update`)
  2. メインでバリデーション→保存→`settings:changed` ブロードキャスト
- **即時反映**: SettingsStoreはObserverパターンでリスナー登録をサポート。UI側はプリロードを通じて現在値と購読APIを使用。
- **競合対策**: UIからのみ更新を許可。外部ファイル編集は監視し、差分があればユーザへ確認 (`prompt` | `auto` | `ignore`)。

## 3. ログ管理 (T2-2)
- **ライブラリ**: `electron-log` または `winston` を検討。今回は拡張性を優先し `winston` 採用。
- **出力先**: `app.getPath("logs")/yyyyMMdd/HHmmss.log` 形式のディレクトリに保存。サイズ/世代/日数は設定値でローテーション。
- **構成**:
  - `LogService` クラスでトランスポート構成（ファイル + コンソール）。
  - 変換処理等はカテゴリ別タグでロギング。
  - LLM利用時の匿名化ログをサポートする `audit` レベルを拡張レベルとして実装。

## 4. ファイルI/O層 (T2-3)
- **ディレクトリ構造**: `_input/`, `_out/`, `_logs/` をアプリ起動時にEnsure。
- **文字コード**: `chardet` で推定→`iconv-lite` でUTF-8化。失敗時は設定の `file.encodingFallback` に従う。
- **入出力API**: `FileService` 提供メソッド
  - `readTextFile(path)` → {text, encoding}
  - `writeJson(path, data)` → pretty print (2 spaces)
  - `copyToInputDir(sourcePath)` → 日時付きファイル名＋既存重複防止
- **エラー処理**: 例外発生時に `LogService.error` とユーザ通知IPCを実施。致命的でない場合は再試行オプション。

## 5. IPC設計 (T2-4)
- 設定・ログ・ファイル関連のIPCチャネルを `src/main/ipc/channels.ts` に列挙。
- Preloadにて `contextBridge` で `settings`, `file`, `log` APIをエクスポート。
- IPC通信は型安全のため `src/shared/ipc.ts` にリクエスト/レスポンス型を定義。

## 6. 実装計画
1. `src/shared/settings` に型＆既定値 & Zodスキーマを実装。
2. `SettingsService` (メイン) と `settings.preload` のBridgeを実装。単体テストはVitest Node環境で実行。
3. `LogService` を実装し、初期化時に設定値を読み込む。ログレベル変更は `settings:changed` を購読。
4. `FileService` でファイル操作をカプセル化。SJIS検知・変換テストを追加。
5. IPCブリッジとプリロードAPIのテストを整備。

## 7. 残課題
- UI側での設定編集画面はP6で実装予定。現在は内部APIのみ提供。
- ログ監査要件（匿名化・トークン概数記録）の詳細はT3-2 LLM連携で補完予定。
- マルチプロセス間のエラーハンドリング（Rendererでの通知UI）は未実装。

