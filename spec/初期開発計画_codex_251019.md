# 開発計画書

## 1. 目的
- `spec/SW要求仕様書.md`・`spec/UI設計書.md`・`doc/操作ガイド.md`で定義された要件を満たすElectron/React/TypeScriptアプリを段階的に実装する。
- 作業完了ごとに`report/`配下へ作業報告を残し、仕様書類も必ず更新するという運用ルールを守る。

## 2. 前提・制約
- 技術スタック: Electron + React 18 + TypeScript, Tailwind CSS, Zustand/Redux Toolkit, react-window, react-dnd, react-split-pane。
- プラットフォーム: Windows / macOS / Linux (Electron Builder想定)。
- ログ・設定・カード/トレースデータはJSONで永続化。設定変更は即時反映、ログはローテーション必須。
- LLM連携は将来のAPI差し替えを考慮した抽象化を前提にする。
- 開発フロー: コミットメッセージは日本語、必要ファイルはステージングのみでコミット許可は都度確認。

## 3. 開発方針
- 小さな単位でElectronメイン/レンダラ/共有層を並行拡張できるよう、API境界を明確化する。
- UIはUI設計書の構造を保つ最小構成から着手し、段階的に機能モジュールを差し込む。
- 仕様変更や追加要件はドキュメントへ即時反映し、レポートで作業範囲を明示する。
- 各フェーズ完了時に`npm test`および該当E2E/結合テスト・lintを実行、結果を作業報告に添付する。

## 4. フェーズ構成
| フェーズ | 目的 / 主な成果物 | 開始条件 | 完了条件 |
| --- | --- | --- | --- |
| P0 環境準備・方針確定 | 開発環境整備、仕様読み合わせ、ディレクトリ/ツール方針確定 | 依頼受領後 | 作業ログ方針決定、基本方針レビュー完了 |
| P1 プロジェクト雛形 | Electron+React+TSのビルド/実行/テスト足場 | P0完了 | `npm start`/`npm run electron`/`npm test`成功、最低限のCIタスク定義 |
| P2 共通基盤 | 設定/ログ/ファイルI/O/IPC土台 | P1完了 | 設定即時反映とログローテの単体テスト合格 |
| P3 カード変換 | 固定ルール変換とLLM抽象化プロトコル | P2完了 | 代表的文章でカードJSONを生成しテストが通る |
| P4 カード編集UI | UIレイアウト・カード編集・多選択/ドラッグ | P3完了 | UI設計書の操作要件を満たす動作確認 |
| P5 トレーサビリティ | コネクタ表示/編集、双方向同期 | P4完了 | トレースCRUDとフィルタリングのE2Eテスト完了 |
| P6 補助機能 & アクセシビリティ | 設定UI/ショートカット/テーマ/アクセシビリティ | P5完了 | WCAGチェックリスト対応、ショートカット管理テスト合格 |
| P7 仕上げ | パフォーマンス最適化、ビルド、ドキュメント/報告 | P6完了 | ビルド成果物、操作ガイド更新、報告書提出 |

## 5. タスク分割と開発順

### フェーズP0: 環境準備・方針確定
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T0-1 | 仕様精読とギャップ整理 | 既存3文書の要求を抜け漏れリスト化 | ギャップ一覧ドラフト作成 | 更新時は仕様書へ反映 |
| T0-2 | リポジトリ診断 | 依存/スクリプト確認、必要ツール(ESLint/Prettier)の採否決定 | 診断メモ作成 | 報告フォーマット草案 |

#### フェーズP0 作業結果（2025-10-19）

**T0-1 仕様精読とギャップ整理**

| No | 要求出典 | 要求ポイント | ギャップ / 要確認事項 | 初期対応方針 |
| --- | --- | --- | --- | --- |
| 1 | SW要求仕様書 2.1 / 9.2 | ログローテーション（サイズ/世代/日数）とログ出力の監査 | 具体的な既定値とログファイル保存パスが未確定。ローテーション失敗時の扱いも未定。 | `config/log`セクションで既定値を提案（例: 10MB/5世代/30日）。メインプロセスでローテーション実装し、失敗時はユーザ通知・フォールバックを設計。 |
| 2 | SW要求仕様書 2.1 / 2.2 | 設定変更の即時反映とUI編集 | 設定ファイル変更の伝播方式（IPC or ファイル監視）が未決定。競合処理ルールも不明。 | メインプロセス集中管理＋IPCブロードキャストを前提に設計案をP1末までに提示。並行編集禁止とし、UI経由のみ許可をドキュメント化。 |
| 3 | SW要求仕様書 3.1 | SJIS/CP932自動変換と巨大ファイル警告 | 文字エンコーディング判定アルゴリズムと変換失敗時のエラーフローが未定。 | `chardet`等を候補に調査し、判定信頼度が低い場合の確認ダイアログ仕様をP1で追記。 |
| 4 | SW要求仕様書 3.1 / 3.2 | 変換キャンセル時のロールバック | 部分生成済みカード/ログをどこまで巻き戻すか未確定。 | トランザクション的に一時ファイルへ書き出し、完了時にコミットする方式を検討。キャンセル時は一時ファイル破棄で整合性維持。 |
| 5 | SW要求仕様書 7.1 | カードファイルのパス管理（絶対パス保管） | OS差異（Windowsのドライブレター等）に対する扱いやポータブル運用時の相対パス化が未定。 | メタデータは絶対パス＋`file://`整形ではなく標準化した文字列で保持。ポータブル対応の要否を関係者に確認し、必要なら相対パスを補完。 |
| 6 | UI設計書 2.1 / 3.2 | 最大16分割グリッドと再帰分割履歴の保存 | レイアウト構造の状態保持手段（設定ファイルに保存するか）が未定。 | Zustandグローバル状態＋設定ファイルへの永続化を検討。保存形式をP2設計ドキュメントに追記。 |
| 7 | UI設計書 3.4 / 3.6 | 複数選択のショートカットとドラッグ挙動 | キーボード修飾キー（Ctrl/Cmd, Shift）のOS差異設計が未整理。 | クロスプラットフォームの入力マッピング表を作成し、操作ガイドをアップデート。 |
| 8 | UI設計書 5 / 操作ガイド 5 | カスタムショートカット設定とヘルプ更新 | ショートカット変更が即時にヘルプへ反映される仕組みが未定。 | 設定変更時にショートカット定義を共通ストアに集約し、ヘルプ表示コンポーネントへバインドする設計を検討。 |
| 9 | 操作ガイド 7 | ログ・データディレクトリ (`_logs/`, `_input/`, `_out/`) | ディレクトリ自動生成タイミングとパーミッションポリシーが未定。 | アプリ初回起動時に存在チェック→作成する初期化ルーチンをP1完了時点で実装。 |

**T0-2 リポジトリ診断メモ**
- Node/Electron関連ファイル（`package.json`、`tsconfig.json`、`src/`構成）が未作成。フェーズP1で雛形を新規作成する必要あり。
- `report/` ディレクトリが存在せず、作業報告格納先が未整備。P1開始時に空ディレクトリとテンプレートを用意する。
- `.gitignore` が `package-lock.json` を除外しており、依存固定ができない。ロックファイル管理方針を決めた上で必要に応じて更新する。
- Lint/Formatter 設定ファイル (`.eslintrc`, `.prettierrc` 等) が未配置。P1のCI整備タスクで導入する。
- 依存ライセンス・セキュリティチェック（`npm audit` 等）の方針が未定。P1で自動化プロセスを検討。

### フェーズP1: プロジェクト雛形
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T1-1 | パッケージ初期化 | `package.json`整備、スクリプト登録 (`start`,`electron`,`build`,`test`) | npm scripts動作 | Nodeバージョン明記 |
| T1-2 | Electronメインプロセス雛形 | `src/main/index.ts` とIPCベースライン | ウィンドウ起動確認 | ESLint/tsconfig整備 |
| T1-3 | Reactレンダラ雛形 | `src/renderer/App.tsx` とTailwindセットアップ | ホットリロード確認 | Storybook導入検討 |
| T1-4 | CI/テスト足場 | Jest+React Testing Library導入、最低限スナップショット | `npm test`成功 | GitHub Actions雛形 |

### フェーズP2: 共通基盤
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T2-1 | 設定管理モジュール | JSON設定ロード/保存/バリデーション/即時反映 | ユニットテスト通過 | zod等採用検討 |
| T2-2 | ログサービス | ログレベル別出力・ローテーション | ログ出力テスト | `winston`想定 |
| T2-3 | ファイルI/O層 | 入力/出力ディレクトリ管理、SJIS→UTF-8変換 | 代表ファイルで入出力確認 | `iconv-lite` |
| T2-4 | IPCチャンネル設計 | メイン↔レンダラAPI定義、型共有 | 型安全IPCテスト | `electron-ipc-bridge`等 |

### フェーズP3: カード変換
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T3-1 | 固定ルールパーサ | Markdown/テキストから階層付与カード生成 | サンプルで期待JSON一致 | remark/markdown-it活用 |
| T3-2 | LLMアダプタ層 | OpenAI/Gemini/Ollama向け抽象クラスと設定項目 | モックでトークン記録 | 将来API差替可能 |
| T3-3 | 変換ジョブ実行管理 | 非同期実行・キャンセル・進捗通知 | 並行処理テスト | Worker Threads/Electron |
| T3-4 | 変換テスト群 | 変換結果/例外/ロールバック自動テスト | Jestテスト緑化 | Fixtures整備 |

### フェーズP4: カード編集UI
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T4-1 | レイアウト骨格 | メニュー/ツールバー/サイドバー/カードパネル骨組み | UIスナップショットOK | split-pane導入 |
| T4-2 | カード一覧表示 | 仮想スクロールツリー、表示モード切替 | 10kカードで60fps目安 | react-window |
| T4-3 | カード編集フォーム | ダブルクリック編集、ステータス/種別切替 | E2Eで編集確認 | フォームバリデーション |
| T4-4 | ドラッグ&ドロップ | 階層移動、並び替え、親子操作反映 | DnDテスト合格 | react-dnd |
| T4-5 | 複数選択操作 | 離散/連続選択、バッチ編集 | テストケース合格 | Modifierキー対応 |

### フェーズP5: トレーサビリティ管理
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T5-1 | トレースデータモデル | relations編集API、JSON入出力 | 単体テスト緑化 | 方向性/タイプ管理 |
| T5-2 | トレースビュー | コネクタ表示、フィルタ、ハイライト | UIテスト合格 | Canvas/SVG比較検討 |
| T5-3 | トレース編集UI | 関係追加/削除/更新、選択カード連動 | E2Eテスト合格 | Undo/Redo整合性 |

### フェーズP6: 補助機能 & アクセシビリティ
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T6-1 | 設定UI & 即時反映 | テーマ/フォント/自動保存/Undo深度 | UIテスト合格 | Zustandと同期 |
| T6-2 | キーボードショートカット管理 | 設定可能ショートカットとヘルプ表示 | ショートカットテスト | i18n対応検討 |
| T6-3 | アクセシビリティ対策 | ARIA属性/コントラスト/フォーカス管理 | WCAGチェックリスト通過 | axe-core導入 |

### フェーズP7: 仕上げ
| ID | タスク | 内容 | 完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| T7-1 | パフォーマンス最適化 | ボトルネック計測、メモリ/CPU調整 | 主要シナリオ1s以内 | Profiler活用 |
| T7-2 | ビルド/パッケージング | electron-builder設定、3OS成果物生成 | 成果物検証、署名手順整理 | CIで自動化 |
| T7-3 | ドキュメント・レポート | 操作ガイド/仕様反映、`report/`報告作成 | ドキュメントレビュー完了 | リリースノート |

## 6. 品質保証計画
- **テスト階層**: 単体 (Jest) → 結合 (Testing Library) → E2E (Playwright/Spectron)。
- **非機能確認**: パフォーマンス (10kカード)・アクセシビリティ (axe-core)・ロギング/設定の障害シナリオ。
- **CI運用**: lint/test/buildをPull Request単位で自動実行、失敗時に作業中断。
- **レビュー**: 各フェーズ完了時に仕様とドキュメントの差分レビューを必須化。

## 7. リスクと対策
| リスク | 内容 | 対策 |
| --- | --- | --- |
| LLM依存APIの変動 | ベンダー/料金/利用制限の変化 | アダプタ層抽象化と設定ファイルで切替 |
| 大規模データでの描画負荷 | 10kカードでの描画遅延 | 仮想スクロール最適化とパフォーマンス計測 |
| Undo/Redoの一貫性 | 複数カード操作の整合性崩れ | 状態管理ライブラリ活用と統合テスト |
| マルチプラットフォーム差異 | ファイルパスやショートカット差異 | OSごとのユーティリティ層とE2Eテスト |

## 8. 報告・ドキュメント更新フロー
1. タスク完了 → `report/`配下に作業報告テンプレートで記録。
2. 仕様/設計/操作ガイドの該当項目を更新し、差分をレビューで確認。
3. コミット対象をステージングし、コミット前に必ず許可を取得。

以上の順序で開発を進める。
