# カード編集アプリケーション - 将来機能 画面モックアップ

## 0. 概要

本ドキュメントは、`software_requirement.md` の第99章「将来機能メモ」に記載されている将来機能について、`user_interface_design.md` で定義された現在の画面設計をベースとした画面モックアップを示します。

**対象機能:**
1. プロジェクトファイル機能
2. トレースのマトリクス編集機能
3. 影響分析のヒートマップ表示
4. ID自動付与と接頭語指定機能
5. 未トレースカード数表示
6. 右クリックコンテキストメニュー
7. 検索機能の改善（別ダイアログ化）
8. カード履歴管理機能
9. カード出力機能
10. 廃止ステータスの追加
11. カード統合機能
12. Markdown Table表記対応
13. LLM機能の拡張

**デザイン原則:**
- 現在の画面設計のカラーパレット、タイポグラフィ、レイアウト原則を踏襲
- Tailwind CSS のスレート/ブルー系スケールを基準
- ライト/ダークモード両対応
- アイコンベースのUI（ツールチップで説明表示）

---

## 1. プロジェクトファイル機能

### 1.1 概要
プロジェクト単位で、カードファイル、トレースファイル、画面分割構成を保存・復元する機能。

### 1.2 画面構成

#### 1.2.1 プロジェクト管理ダイアログ

**アクセス経路:**
- メニューバー「ファイル(F) > プロジェクト管理(P)」
- ショートカット `Ctrl+Shift+P`

**レイアウト:**
```
┌─────────────────────────────────────────────┐
│ プロジェクト管理               [×]           │
├─────────────────────────────────────────────┤
│                                              │
│ 現在のプロジェクト                           │
│ ┌────────────────────────────────────────┐ │
│ │ 📂 my_project.msp                       │ │
│ │ パス: /workspace/my_project.msp         │ │
│ │                                          │ │
│ │ カードファイル: 5件                      │ │
│ │ トレースファイル: 3件                    │ │
│ │ 最終保存: 2025-10-19 14:30              │ │
│ └────────────────────────────────────────┘ │
│                                              │
│ プロジェクト操作                             │
│ [新規作成] [開く] [上書き保存] [別名保存]   │
│                                              │
│ プロジェクトに含まれるファイル               │
│ ┌────────────────────────────────────────┐ │
│ │ カードファイル                           │ │
│ │ ☑ spec_v1.json                          │ │
│ │ ☑ design_v1.json                        │ │
│ │ ☑ test_plan.json                        │ │
│ │ ☑ meeting_notes.json                    │ │
│ │ ☑ requirements.json                     │ │
│ │                                          │ │
│ │ トレースファイル                         │ │
│ │ ☑ trace_spec_v1_design_v1.json          │ │
│ │ ☑ trace_design_v1_test_plan.json        │ │
│ │ ☑ trace_requirements_spec_v1.json       │ │
│ └────────────────────────────────────────┘ │
│                                              │
│ 画面レイアウト設定                           │
│ ☑ 画面分割構成を保存・復元                   │
│ ☑ オープンファイル情報を保存・復元           │
│                                              │
│                          [保存] [キャンセル] │
└─────────────────────────────────────────────┘
```

**要素詳細:**

1. **現在のプロジェクト表示エリア**
   - プロジェクトファイル名とパス
   - 統計情報（カードファイル数、トレースファイル数）
   - 最終保存日時

2. **プロジェクト操作ボタン**
   - 新規作成 (📄): 新しいプロジェクトファイルを作成
   - 開く (📂): 既存のプロジェクトファイルを開く
   - 上書き保存 (💾): 現在のプロジェクトを保存
   - 別名保存 (📝): 新しい名前で保存

3. **ファイルリスト**
   - チェックボックスでプロジェクトに含めるファイルを選択
   - カードファイルとトレースファイルを分けて表示

4. **画面レイアウト設定**
   - 画面分割構成の保存・復元
   - オープンファイル情報の保存・復元

#### 1.2.2 プロジェクトファイル仕様

**ファイル形式:** `.msp` (MDSplitter Project)

**ファイル内容:**
```json
{
  "schemaVersion": 1,
  "projectName": "my_project",
  "createdAt": "2025-10-19T14:30:00Z",
  "updatedAt": "2025-10-19T14:30:00Z",
  "workspacePath": "/workspace",
  "cardFiles": [
    "spec_v1.json",
    "design_v1.json",
    "test_plan.json"
  ],
  "traceFiles": [
    "trace_spec_v1_design_v1.json",
    "trace_design_v1_test_plan.json"
  ],
  "layout": {
    "splits": [
      {
        "direction": "horizontal",
        "ratio": 0.5,
        "left": { "activeTab": "spec_v1.json" },
        "right": { "activeTab": "design_v1.json" }
      }
    ],
    "openFiles": ["spec_v1.json", "design_v1.json", "test_plan.json"]
  }
}
```

#### 1.2.3 トレース整合性チェック

プロジェクト保存時、トレース関係にあるカードが削除または廃止されている場合は警告ダイアログを表示：

```
┌─────────────────────────────────────────────┐
│ ⚠️ トレーサビリティ警告      [×]             │
├─────────────────────────────────────────────┤
│                                              │
│ 以下のカードは削除または廃止されています     │
│ が、トレーサビリティ情報が残っています。     │
│                                              │
│ spec_v1.json                                 │
│   - Card ID: 12345 (削除済み)                │
│   - トレース先: design_v1.json (Card 67890)  │
│                                              │
│ design_v1.json                               │
│   - Card ID: 11111 (廃止)                    │
│   - トレース先: test_plan.json (Card 22222)  │
│                                              │
│ 保存時に該当するトレーサビリティ情報を       │
│ 削除しますか？                               │
│                                              │
│         [トレース情報を削除して保存] [キャンセル] │
└─────────────────────────────────────────────┘
```

---

## 2. トレースのマトリクス編集機能

### 2.1 概要
2つのカードファイル間のトレーサビリティをマトリクス形式で一覧・編集する機能。

### 2.2 画面構成

#### 2.2.1 マトリクス編集ダイアログ

**アクセス経路:**
- メニューバー「表示(V) > トレースマトリクス(M)」
- ツールバーの「📊マトリクス編集」ボタン
- ショートカット `Ctrl+M`

**レイアウト:**
```
┌──────────────────────────────────────────────────────────────┐
│ トレースマトリクス編集                            [×]         │
├──────────────────────────────────────────────────────────────┤
│ 左ファイル: [spec_v1.json ▾]  右ファイル: [design_v1.json ▾] │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│     │ D-001  │ D-002  │ D-003  │ D-004  │ D-005  │ D-006     │
│     │ 📑設計  │ 📑クラス│ 📊テーブル│ 📝実装  │ 🧪テスト│ 💬QA   │
├─────┼────────┼────────┼────────┼────────┼────────┼─────────┤
│S-001│   👉   │        │        │   ⇔    │        │          │
│📑要件│        │        │        │        │        │          │
├─────┼────────┼────────┼────────┼────────┼────────┼─────────┤
│S-002│        │   👉   │   👉   │        │        │          │
│📝機能│        │        │        │        │        │          │
├─────┼────────┼────────┼────────┼────────┼────────┼─────────┤
│S-003│        │        │        │        │   👈   │          │
│🧪試験│        │        │        │        │        │          │
├─────┼────────┼────────┼────────┼────────┼────────┼─────────┤
│S-004│        │        │        │        │        │   ⇔      │
│💬質問│        │        │        │        │        │          │
└─────┴────────┴────────┴────────┴────────┴────────┴─────────┘
│                                                                │
│ 選択中: S-001 (要件定義) ⇔ D-004 (実装仕様)                   │
│ トレース種別: [trace ▾]  方向性: [⇔ 双方向 ▾]                 │
│ メモ: [______________________________________]                 │
│                                                                │
│ 統計情報                                                       │
│ 総トレース数: 8  未トレース (左): 2  未トレース (右): 1       │
│                                                                │
│                              [保存] [キャンセル] [エクスポート] │
└──────────────────────────────────────────────────────────────┘
```

**要素詳細:**

1. **ファイル選択ドロップダウン**
   - 左右のカードファイルを選択
   - 選択変更時にマトリクスを再描画

2. **マトリクス表示**
   - 横軸: 右ファイルのカード（ID + アイコン + タイトル）
   - 縦軸: 左ファイルのカード（ID + アイコン + タイトル）
   - セル内容: トレース方向のアイコン
     - 👉: 左→右
     - 👈: 右→左
     - ⇔: 双方向
     - (空白): トレースなし

3. **セル操作**
   - クリック: トレースの作成/編集
   - 右クリック: トレースの削除
   - ホバー: カード内容のツールチップ表示

4. **選択中トレース情報**
   - 選択中のセルに対応するトレース情報を表示
   - トレース種別、方向性、メモを編集可能

5. **統計情報**
   - 総トレース数
   - 未トレースカード数（左右それぞれ）

6. **操作ボタン**
   - 保存: トレーサビリティファイルに保存
   - キャンセル: 変更を破棄
   - エクスポート: マトリクスをCSV/Excel形式で出力

#### 2.2.2 マトリクス表示のカスタマイズ

**フィルタ機能:**
```
┌────────────────────────────────────┐
│ フィルタ                            │
│ カード種別:                        │
│ ☑ 見出し  ☑ 段落  ☑ 箇条書き       │
│ ☑ 図      ☑ 表    ☑ 試験  ☑ QA    │
│                                     │
│ トレース状態:                      │
│ ☑ トレースあり  ☑ トレースなし     │
│                                     │
│ トレース種別:                      │
│ ☑ trace    ☑ refines  ☑ tests     │
│ ☑ satisfy  ☑ relate   ☑ specialize│
└────────────────────────────────────┘
```

**ハイライト機能:**
- 未トレースのカードは背景色をアンバー系で強調
- 選択中の行・列は背景色をブルー系で強調

---

## 3. 影響分析のヒートマップ表示

### 3.1 概要
カードのトレース接続数に応じて背景色を変化させ、影響範囲を視覚的に表現する機能。

### 3.2 画面構成

#### 3.2.1 ヒートマップ表示モード

**有効化:**
- ツールバーの「🔥 ヒートマップ」トグルボタン
- メニューバー「表示(V) > ヒートマップ表示(H)」

**カードの背景色:**
トレース接続数に応じてグラデーション表示

```
トレース接続数: 0件
┌─────────────────────────────┐
│ ● 📑 [Draft]                 ●│
│                               │
│ カード内容...                 │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
背景色: スレート50 (通常表示)

トレース接続数: 1-2件
┌─────────────────────────────┐
│ ● 📑 [Draft]                 ●│
│                               │
│ カード内容...                 │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
背景色: グリーン50 (低影響)

トレース接続数: 3-5件
┌─────────────────────────────┐
│ ● 📑 [Draft]                 ●│
│                               │
│ カード内容...                 │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
背景色: イエロー50 (中影響)

トレース接続数: 6-10件
┌─────────────────────────────┐
│ ● 📑 [Draft]                 ●│
│                               │
│ カード内容...                 │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
背景色: オレンジ50 (高影響)

トレース接続数: 11件以上
┌─────────────────────────────┐
│ ● 📑 [Draft]                 ●│
│                               │
│ カード内容...                 │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
背景色: レッド50 (超高影響)
```

#### 3.2.2 ヒートマップ凡例

ツールバーまたはカードパネルツールバーに凡例を表示：

```
┌────────────────────────────────────────────┐
│ ヒートマップ凡例                            │
│ □ 0件  □ 1-2件  □ 3-5件  □ 6-10件  □ 11+件 │
│   なし   低      中       高        超高     │
└────────────────────────────────────────────┘
```

#### 3.2.3 ヒートマップ設定

設定ビューから閾値をカスタマイズ可能：

```
┌────────────────────────────────────┐
│ ヒートマップ設定                    │
│                                     │
│ 接続数の閾値:                      │
│ 低影響:    [1] 〜 [2]              │
│ 中影響:    [3] 〜 [5]              │
│ 高影響:    [6] 〜 [10]             │
│ 超高影響:  [11] 以上               │
│                                     │
│ カラーパレット:                    │
│ ○ デフォルト (グリーン→レッド)     │
│ ○ ブルー系 (ブルー→パープル)       │
│ ○ モノクロ (グレー→ブラック)       │
│                                     │
│              [保存] [キャンセル]    │
└────────────────────────────────────┘
```

---

## 4. ID自動付与と接頭語指定機能

### 4.1 概要
カード変換時に、カードIDを自動付与し、接頭語を指定できる機能。

### 4.2 画面構成

#### 4.2.1 変換ダイアログの拡張

既存の「ファイルを開くダイアログ」に以下の設定項目を追加：

```
┌─────────────────────────────────────────────┐
│ ファイルを開く                              │
├─────────────────────────────────────────────┤
│                                              │
│ ファイルパス:                                │
│ [/workspace/spec.md                     ] [📂]│
│                                              │
│ 変換方法:                                    │
│ ○ 固定ルール (rule)                         │
│ ○ LLM (llm)                                 │
│                                              │
│ ──────────────────────────────────────────  │
│ ID設定                                       │
│ ──────────────────────────────────────────  │
│                                              │
│ ☑ カードIDを自動付与                         │
│                                              │
│ ID接頭語:  [SPEC-]                           │
│ 開始番号:  [1]                               │
│ 桁数:      [3] (例: SPEC-001)                │
│                                              │
│ ID付与ルール:                                │
│ ○ すべてのカードに付与                       │
│ ○ 見出しカードのみに付与                     │
│ ○ 特定のカード種別のみ: [☑見出し ☑段落 ...]  │
│                                              │
│ プレビュー: SPEC-001, SPEC-002, SPEC-003...  │
│                                              │
│                          [変換] [キャンセル] │
└─────────────────────────────────────────────┘
```

**要素詳細:**

1. **ID自動付与チェックボックス**
   - チェックするとID設定エリアが有効化

2. **ID接頭語**
   - カードIDの接頭語を指定（例: "SPEC-", "REQ-", "DES-"）
   - 空欄の場合は番号のみ

3. **開始番号**
   - IDの開始番号を指定（既定: 1）

4. **桁数**
   - ID番号の桁数（ゼロパディング）を指定（既定: 3）

5. **ID付与ルール**
   - すべてのカード、見出しのみ、特定種別のみから選択

6. **プレビュー**
   - 設定に基づくID例を表示

#### 4.2.2 変換後のカード表示

カードのデータモデルに `cardId` フィールドを追加：

```json
{
  "id": "uuid-v4-string",
  "cardId": "SPEC-001",
  "type": "heading",
  "status": "draft",
  "content": {
    "text": "要件定義",
    "number": ""
  },
  ...
}
```

カード表示時にカードID を表示：

```
┌─────────────────────────────┐
│ ● 📑 [Draft] SPEC-001        ●│
│                               │
│ 要件定義                      │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
```

---

## 5. 未トレースカード数表示

### 5.1 概要
カードパネルのツールバーに、未トレースカード数を表示する機能。

### 5.2 画面構成

#### 5.2.1 カードパネルツールバーの拡張

カードパネルツールバーの右端に統計情報を追加：

```
┌──────────────────────────────────────────────────────────┐
│ [⏬] [⏫] [🔍____] [📚] [⛓️] [MD] [☰]    統計: 150件 (未: 12)│
└──────────────────────────────────────────────────────────┘
```

**要素詳細:**

1. **総カード数**
   - フィルタ適用前の総カード数を表示

2. **未トレースカード数**
   - トレーサビリティ情報が存在しないカードの数
   - 括弧内に「未: XX」形式で表示
   - クリックすると未トレースカードのみを表示（フィルタ適用）

#### 5.2.2 未トレースカードのフィルタ表示

未トレースカード数をクリックすると、フィルタが適用され未トレースカードのみが表示される：

```
┌──────────────────────────────────────────────────────────┐
│ [⏬] [⏫] [🔍____] [📚] [⛓️] [MD] [☰]  フィルタ: 未トレース │
│                                         [×フィルタ解除]    │
└──────────────────────────────────────────────────────────┘
│                                                            │
│ ┌─────────────────────────────┐                          │
│ │ ○ 📑 [Draft] SPEC-005        ○│ ← 未トレース             │
│ │                               │                          │
│ │ 要件5: データベース設計       │                          │
│ │ 最終更新: 2025-10-19 14:30   │                          │
│ └─────────────────────────────┘                          │
│                                                            │
│ ┌─────────────────────────────┐                          │
│ │ ○ 📝 [Draft] SPEC-012        ○│ ← 未トレース             │
│ │                               │                          │
│ │ 機能仕様: API設計             │                          │
│ │ 最終更新: 2025-10-19 14:35   │                          │
│ └─────────────────────────────┘                          │
```

#### 5.2.3 詳細な統計情報

ステータスバーにも詳細な統計情報を表示：

```
┌──────────────────────────────────────────────────────────┐
│ 総: 150  表示: 150  選択: 2  未トレース: 12  廃止: 3       │
└──────────────────────────────────────────────────────────┘
```

---

## 6. 右クリックコンテキストメニュー

### 6.1 概要
カードを右クリックした際に表示されるコンテキストメニュー。

### 6.2 画面構成

#### 6.2.1 コンテキストメニュー

**カード上で右クリック:**

```
┌─────────────────────────────┐
│ ● 📑 [Draft] SPEC-001        ●│ ← 右クリック
│                               │
│ 要件定義                      │   ┌────────────────────────┐
│                               │   │ ✏️  編集               │
│ 最終更新: 2025-10-19 14:30   │   │ 📋  コピー             │
└─────────────────────────────┘   │ 📥  貼り付け           │
                                   │   ├ 前に貼り付け       │
                                   │   ├ 後に貼り付け       │
                                   │   └ 子として貼り付け   │
                                   │ ➕  カード追加         │
                                   │   ├ 前に追加           │
                                   │   ├ 後に追加           │
                                   │   └ 子として追加       │
                                   │ 🗑️  削除               │
                                   │ ────────────────────   │
                                   │ 📄  テキストとしてコピー│
                                   │ 🔗  IDをコピー         │
                                   │ ────────────────────   │
                                   │ 📊  統計情報           │
                                   │ 📜  履歴を表示         │
                                   └────────────────────────┘
```

**メニュー項目:**

1. **編集**
   - カードを編集モードにする（ダブルクリックと同じ）

2. **コピー**
   - 選択中のカードをクリップボードにコピー
   - 複数選択時は全てコピー

3. **貼り付け**
   - サブメニューで貼り付け位置を選択
   - 前に貼り付け: 選択カードの前に挿入
   - 後に貼り付け: 選択カードの後に挿入
   - 子として貼り付け: 選択カードの子として挿入

4. **カード追加**
   - サブメニューで追加位置を選択
   - 前に追加: 選択カードの前に新規カード追加
   - 後に追加: 選択カードの後に新規カード追加
   - 子として追加: 選択カードの子として新規カード追加

5. **削除**
   - 選択中のカードを削除

6. **テキストとしてコピー**
   - カードの内容をプレーンテキストとしてクリップボードにコピー
   - 複数選択時は全カードの内容を改行区切りでコピー

7. **IDをコピー**
   - カードのID（UUID）をクリップボードにコピー
   - トレース作成や検索で利用

8. **統計情報**
   - カードの統計情報をダイアログで表示（下記参照）

9. **履歴を表示**
   - カードの変更履歴を表示（カード履歴管理機能）

#### 6.2.2 統計情報ダイアログ

「統計情報」を選択すると表示されるダイアログ：

```
┌─────────────────────────────────────────────┐
│ カード統計情報 - SPEC-001        [×]         │
├─────────────────────────────────────────────┤
│                                              │
│ 基本情報                                     │
│ ──────────────────────────────────────────  │
│ カードID:      SPEC-001                      │
│ UUID:          12345678-1234-1234-1234-...   │
│ 種別:          📑 見出し                     │
│ ステータス:    Draft                         │
│ 作成日時:      2025-10-18 10:00              │
│ 最終更新:      2025-10-19 14:30              │
│                                              │
│ トレーサビリティ                             │
│ ──────────────────────────────────────────  │
│ トレース接続数: 3件                          │
│   ├ design_v1.json: 2件                      │
│   └ test_plan.json: 1件                      │
│                                              │
│ 階層情報                                     │
│ ──────────────────────────────────────────  │
│ 階層レベル:    2                             │
│ 親カード:      SPEC-000 (ルート)             │
│ 子カード数:    5件                           │
│                                              │
│ 内容統計                                     │
│ ──────────────────────────────────────────  │
│ 文字数:        1,234文字                     │
│ 行数:          56行                          │
│                                              │
│                                    [閉じる] │
└─────────────────────────────────────────────┘
```

---

## 7. 検索機能の改善（別ダイアログ化）

### 7.1 概要
検索機能を独立したダイアログとして実装し、API・MCP機能のクエリと共通化する。

### 7.2 画面構成

#### 7.2.1 検索ダイアログ

**アクセス経路:**
- メニューバー「表示(V) > 検索(F)」
- ショートカット `Ctrl+F`

**レイアウト:**
```
┌─────────────────────────────────────────────────────────────┐
│ 検索                                                 [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ クエリ種別: [通常検索 ▾]                                      │
│                                                               │
│ 検索キーワード:                                               │
│ [___________________________________________________]         │
│                                                               │
│ 検索範囲:                                                     │
│ ○ アクティブタブ  ○ 開いているタブ  ○ _inputディレクトリ     │
│                                                               │
│ 検索オプション:                                               │
│ ☑ 正規表現  ☑ 大文字小文字を区別  ☑ 単語単位で検索          │
│                                                               │
│ カード種別フィルタ:                                           │
│ ☑ 見出し  ☑ 段落  ☑ 箇条書き  ☑ 図  ☑ 表  ☑ 試験  ☑ QA     │
│                                                               │
│ ステータスフィルタ:                                           │
│ ☑ Draft  ☑ Review  ☑ Approved  ☑ Deprecated                 │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ 検索結果: 8件                                    [検索] [クリア]│
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 📄 spec_v1.json (3件)                                   │   │
│ │   ├ SPEC-001: 要件定義                                  │   │
│ │   │  ...要件定義の内容テキスト...                       │   │
│ │   ├ SPEC-005: データベース設計                          │   │
│ │   │  ...データベース設計の内容テキスト...               │   │
│ │   └ SPEC-012: API設計                                   │   │
│ │      ...API設計の内容テキスト...                        │   │
│ │                                                          │   │
│ │ 📄 design_v1.json (2件)                                 │   │
│ │   ├ DES-003: クラス設計                                 │   │
│ │   │  ...クラス設計の内容テキスト...                     │   │
│ │   └ DES-008: シーケンス図                               │   │
│ │      ...シーケンス図の内容テキスト...                   │   │
│ │                                                          │   │
│ │ 📄 test_plan.json (3件)                                 │   │
│ │   ├ TEST-001: 単体テスト                                │   │
│ │   │  ...単体テストの内容テキスト...                     │   │
│ │   ├ TEST-005: 結合テスト                                │   │
│ │   │  ...結合テストの内容テキスト...                     │   │
│ │   └ TEST-010: システムテスト                            │   │
│ │      ...システムテストの内容テキスト...                 │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ ナビゲーション: ← 前へ  次へ →  Ctrl+Enter: カードにジャンプ  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**要素詳細:**

1. **クエリ種別**
   - 通常検索: テキスト検索
   - ID検索: カードIDで検索
   - トレース検索: トレース関係にあるカードを検索
   - 未トレース検索: トレースのないカードを検索
   - 高度な検索: 複数条件の組み合わせ

2. **検索キーワード**
   - テキスト入力欄
   - 正規表現対応

3. **検索範囲**
   - アクティブタブ: 現在選択中のカードファイル
   - 開いているタブ: 開いている全カードファイル
   - _inputディレクトリ: 入力フォルダ内の全カードファイル

4. **検索オプション**
   - 正規表現
   - 大文字小文字を区別
   - 単語単位で検索

5. **カード種別フィルタ**
   - 検索対象のカード種別を選択

6. **ステータスフィルタ**
   - 検索対象のステータスを選択

7. **検索結果リスト**
   - ファイル名ごとにグループ化
   - カードID、タイトル、内容のスニペットを表示
   - クリックで該当カードにジャンプ
   - キーボード操作（↑↓）で選択、Ctrl+Enterでジャンプ

#### 7.2.2 高度な検索（クエリビルダー）

クエリ種別で「高度な検索」を選択した場合：

```
┌─────────────────────────────────────────────────────────────┐
│ 検索 - 高度な検索                                    [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 検索条件を追加:                                               │
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 条件1: [カード種別 ▾] [が次と等しい ▾] [見出し ▾]  [×]│   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 条件2: [テキスト ▾] [が次を含む ▾] [要件]         [×]│   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 条件3: [トレース数 ▾] [が次より大きい ▾] [5]      [×]│   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ [+ 条件を追加]                                                │
│                                                               │
│ 条件の組み合わせ:                                             │
│ ○ すべての条件に一致 (AND)                                   │
│ ○ いずれかの条件に一致 (OR)                                  │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ 検索結果: 3件                                    [検索] [クリア]│
│                                                               │
│ [検索結果リスト...]                                           │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**検索条件の種類:**
- カード種別: 見出し、段落、箇条書き、図、表、試験、QA
- テキスト: カード内容のテキスト
- カードID: カードIDまたはUUID
- ステータス: Draft, Review, Approved, Deprecated
- トレース数: トレース接続の数
- 階層レベル: 階層の深さ
- 作成日時: カードの作成日時
- 最終更新日時: カードの最終更新日時

**比較演算子:**
- が次と等しい
- が次と等しくない
- が次を含む
- が次を含まない
- が次より大きい
- が次より小さい
- が次以上
- が次以下

---

## 8. カード履歴管理機能

### 8.1 概要
カード単位で変更履歴を保存し、履歴を表示する機能。

### 8.2 画面構成

#### 8.2.1 カード履歴表示

**アクセス経路:**
- カード上で右クリック > 「履歴を表示」
- カード選択中にメニューバー「表示(V) > 履歴(H)」
- ショートカット `Ctrl+H`（カード選択中）

**レイアウト:**
```
┌─────────────────────────────────────────────────────────────┐
│ カード履歴 - SPEC-001                                [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 現在のバージョン v5 (2025-10-19 14:30)         [復元] [比較] │
│                                                               │
│ 履歴 (全5件)                                                  │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ v5  2025-10-19 14:30  更新者: Alice  [現在]           │   │
│ │     ステータス変更: Draft → Review                     │   │
│ │                                                        │   │
│ │ v4  2025-10-19 10:15  更新者: Bob                     │   │
│ │     内容編集: テキスト修正 (+50文字, -20文字)         │   │
│ │                                                        │   │
│ │ v3  2025-10-18 16:45  更新者: Alice                   │   │
│ │     内容編集: テキスト追加 (+120文字)                 │   │
│ │                                                        │   │
│ │ v2  2025-10-18 14:20  更新者: Charlie                 │   │
│ │     移動: 階層レベル 1 → 2                            │   │
│ │                                                        │   │
│ │ v1  2025-10-18 10:00  更新者: Alice  [初版]           │   │
│ │     作成                                               │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ 選択中: v4 (2025-10-19 10:15)                                 │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 差分表示                                               │   │
│ │                                                        │   │
│ │ - 旧: 要件定義の初期バージョン                         │   │
│ │ + 新: 要件定義の初期バージョン（修正版）               │   │
│ │                                                        │   │
│ │ - 旧: データベース設計に関する要件を記載する。        │   │
│ │ + 新: データベース設計とAPI設計に関する要件を記載する。│   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│                              [復元] [エクスポート] [閉じる]   │
└─────────────────────────────────────────────────────────────┘
```

**要素詳細:**

1. **現在のバージョン表示**
   - バージョン番号、最終更新日時を表示
   - [復元]: 選択したバージョンに復元
   - [比較]: 2つのバージョンを比較

2. **履歴リスト**
   - バージョン番号、更新日時、更新者、変更内容の要約を表示
   - クリックでバージョンを選択

3. **差分表示**
   - 選択したバージョンと直前のバージョンの差分を表示
   - 削除行は `-` と赤色
   - 追加行は `+` と緑色

4. **操作ボタン**
   - 復元: 選択したバージョンに復元（確認ダイアログ表示）
   - エクスポート: 履歴をテキスト/JSON形式でエクスポート
   - 閉じる: ダイアログを閉じる

#### 8.2.2 履歴ファイル仕様

**ファイル形式:** `_history/<cardfile>_<cardid>_history.json`

**ファイル内容:**
```json
{
  "schemaVersion": 1,
  "cardFile": "spec_v1.json",
  "cardId": "SPEC-001",
  "cardUuid": "12345678-1234-1234-1234-...",
  "history": [
    {
      "version": 5,
      "timestamp": "2025-10-19T14:30:00Z",
      "user": "Alice",
      "changeType": "status",
      "changes": {
        "status": { "old": "draft", "new": "review" }
      },
      "snapshot": {
        "id": "12345678-1234-1234-1234-...",
        "cardId": "SPEC-001",
        "type": "heading",
        "status": "review",
        "content": { "text": "要件定義", "number": "" },
        ...
      }
    },
    {
      "version": 4,
      "timestamp": "2025-10-19T10:15:00Z",
      "user": "Bob",
      "changeType": "content",
      "changes": {
        "content.text": {
          "old": "要件定義の初期バージョン",
          "new": "要件定義の初期バージョン（修正版）"
        }
      },
      "snapshot": { ... }
    },
    ...
  ]
}
```

---

## 9. カード出力機能

### 9.1 概要
カードファイルとトレーサビリティ情報を各種形式で出力する機能。

### 9.2 画面構成

#### 9.2.1 エクスポートダイアログ

**アクセス経路:**
- メニューバー「ファイル(F) > エクスポート(E)」
- ショートカット `Ctrl+Shift+E`

**レイアウト:**
```
┌─────────────────────────────────────────────────────────────┐
│ エクスポート                                         [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ エクスポート形式:                                             │
│ ○ カードリスト (CSV)                                         │
│ ○ トレーサビリティマトリクス (CSV/Excel)                     │
│ ○ 影響範囲分析 (CSV/JSON)                                    │
│ ○ ナレッジグラフ (RDF/JSON-LD)                               │
│ ○ Markdown文書 (MD)                                          │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ エクスポート対象:                                             │
│ ○ アクティブタブ                                             │
│ ○ 開いているすべてのタブ                                     │
│ ○ プロジェクト全体                                           │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ カードリスト (CSV) のオプション:                              │
│ ☑ ヘッダー行を含める                                         │
│ ☑ 階層構造を保持（インデント）                               │
│ ☑ トレース接続数を含める                                     │
│ 区切り文字: [コンマ (,) ▾]                                   │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ 出力先:                                                       │
│ [/workspace/export/cards.csv                          ] [📂] │
│                                                               │
│                                    [エクスポート] [キャンセル] │
└─────────────────────────────────────────────────────────────┘
```

**要素詳細:**

1. **エクスポート形式**
   - カードリスト (CSV): カード一覧をCSV形式で出力
   - トレーサビリティマトリクス (CSV/Excel): トレースマトリクスを表形式で出力
   - 影響範囲分析 (CSV/JSON): 指定カードの影響範囲を出力
   - ナレッジグラフ (RDF/JSON-LD): グラフデータベース用の形式で出力
   - Markdown文書 (MD): 元のMarkdown形式に再構築して出力

2. **エクスポート対象**
   - アクティブタブ: 現在選択中のカードファイル
   - 開いているすべてのタブ: 開いている全カードファイル
   - プロジェクト全体: プロジェクトファイルに含まれる全カードファイル

3. **形式別オプション**
   - 選択した形式に応じたオプションを動的に表示

4. **出力先**
   - ファイルパスを指定

#### 9.2.2 カードリスト (CSV) の出力例

```csv
CardID,UUID,Type,Status,Content,Level,Parent,TraceCount,UpdatedAt
SPEC-001,12345...,heading,review,要件定義,1,NULL,3,2025-10-19 14:30
SPEC-002,67890...,paragraph,draft,機能仕様,2,SPEC-001,2,2025-10-19 14:35
SPEC-003,11111...,bullet,draft,- データベース設計,3,SPEC-002,1,2025-10-19 14:40
```

#### 9.2.3 影響範囲分析の出力

**影響範囲分析の設定ダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ 影響範囲分析                                         [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 起点カード:                                                   │
│ [SPEC-001: 要件定義                                  ] [🔍]  │
│                                                               │
│ 分析深度:                                                     │
│ ○ 直接トレースのみ (1階層)                                   │
│ ○ 2階層まで                                                  │
│ ○ 3階層まで                                                  │
│ ○ すべての階層                                               │
│                                                               │
│ トレース方向:                                                 │
│ ☑ 順方向 (SPEC-001 → DES-001)                               │
│ ☑ 逆方向 (DES-001 → SPEC-001)                               │
│                                                               │
│ 出力形式:                                                     │
│ ○ CSV (カードリスト)                                         │
│ ○ JSON (階層構造)                                            │
│ ○ グラフ画像 (PNG/SVG)                                       │
│                                                               │
│ ──────────────────────────────────────────────────────────  │
│                                                               │
│ プレビュー:                                                   │
│ 影響範囲: 12カード (2ファイル、3階層)                        │
│                                                               │
│ SPEC-001 (起点)                                               │
│   └→ DES-001, DES-003                                         │
│       └→ TEST-005, TEST-012                                   │
│           └→ QA-002                                           │
│                                                               │
│                                      [分析実行] [キャンセル]   │
└─────────────────────────────────────────────────────────────┘
```

#### 9.2.4 ナレッジグラフ (RDF) の出力例

```turtle
@prefix card: <http://example.org/card#> .
@prefix trace: <http://example.org/trace#> .

card:SPEC-001 a card:Heading ;
    card:id "SPEC-001" ;
    card:uuid "12345678-1234-1234-1234-..." ;
    card:status "review" ;
    card:content "要件定義" ;
    card:updatedAt "2025-10-19T14:30:00Z" ;
    trace:refines card:DES-001, card:DES-003 .

card:DES-001 a card:Paragraph ;
    card:id "DES-001" ;
    card:uuid "67890..." ;
    card:status "draft" ;
    card:content "設計仕様" ;
    card:updatedAt "2025-10-19T14:35:00Z" ;
    trace:refinedBy card:SPEC-001 ;
    trace:tests card:TEST-005 .
```

---

## 10. 廃止ステータスの追加

### 10.1 概要
カードのステータスに「廃止 (Deprecated)」を追加し、廃止カードのトレース接続を制限する機能。

### 10.2 画面構成

#### 10.2.1 廃止ステータスの表示

**ステータスバッジ:**
```
┌─────────────────────────────┐
│ ● 📑 [Deprecated] SPEC-005   ○│ ← トレース接合点が無効化
│                               │
│ データベース設計（廃止）      │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
```

**カラーパレット:**
- ライトモード: `bg-rose-100` / `text-rose-600`
- ダークモード: `bg-rose-500/20` / `text-rose-200`

#### 10.2.2 廃止ステータスの制約

1. **トレース接合点の無効化**
   - 廃止ステータスのカードは、トレース接合点が `○`（無効）で表示される
   - クリックしてもコネクタを作成できない
   - 既存のコネクタは保持されるが、視覚的に識別可能（グレーアウト）

2. **既存トレースの警告**
   - カードを廃止ステータスに変更した際、既存のトレースがある場合は警告ダイアログを表示：

```
┌─────────────────────────────────────────────┐
│ ⚠️ 廃止ステータスへの変更      [×]           │
├─────────────────────────────────────────────┤
│                                              │
│ このカードには以下のトレース接続があります:  │
│                                              │
│ - design_v1.json (Card DES-001)              │
│ - design_v1.json (Card DES-003)              │
│ - test_plan.json (Card TEST-005)             │
│                                              │
│ 廃止ステータスに変更すると、新しいトレース   │
│ 接続ができなくなります。既存のトレースは     │
│ 保持されますが、グレーアウト表示されます。   │
│                                              │
│ 続行しますか？                               │
│                                              │
│                          [続行] [キャンセル] │
└─────────────────────────────────────────────┘
```

3. **フィルタ機能**
   - 廃止カードを表示/非表示にするフィルタオプション
   - カードパネルツールバーに「廃止カードを表示」トグル追加

---

## 11. カード統合機能

### 11.1 概要
同一パネル内で、同一かつ連続選択中カードを統合する機能。

### 11.2 画面構成

#### 11.2.1 統合操作

**選択:**
- 統合したいカードを連続選択（SHIFT + クリック）
- 選択カードは同一階層かつ連続している必要がある

**統合ダイアログ:**
```
┌─────────────────────────────────────────────┐
│ カード統合                        [×]        │
├─────────────────────────────────────────────┤
│                                              │
│ 統合対象カード: 3件                          │
│ - SPEC-002: 機能仕様                         │
│ - SPEC-003: データベース設計                 │
│ - SPEC-004: API設計                          │
│                                              │
│ 統合後のカード情報:                          │
│                                              │
│ カードID:      [SPEC-002        ▾]          │
│                (最初のカードIDを使用)        │
│                                              │
│ 種別:          [段落 (paragraph) ▾]         │
│                                              │
│ ステータス:    [Draft            ▾]         │
│                                              │
│ 内容:                                        │
│ ┌──────────────────────────────────────┐   │
│ │ 機能仕様                               │   │
│ │                                        │   │
│ │ データベース設計                       │   │
│ │                                        │   │
│ │ API設計                                │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ ☑ 元のカードを削除                           │
│ ☑ トレース情報を統合後カードに引き継ぐ       │
│                                              │
│                          [統合] [キャンセル] │
└─────────────────────────────────────────────┘
```

**要素詳細:**

1. **統合対象カード**
   - 選択中のカード一覧を表示

2. **統合後のカード情報**
   - カードID: 最初のカードIDまたは新規ID
   - 種別: 統合後のカード種別を選択
   - ステータス: 統合後のステータスを選択
   - 内容: 統合後のテキスト内容（編集可能）

3. **オプション**
   - 元のカードを削除: 統合後に元のカードを削除
   - トレース情報を統合: 元のカードのトレース情報を統合後カードに引き継ぐ

#### 11.2.2 統合後の処理

1. **カード削除**
   - 元のカードを削除（オプション有効時）

2. **トレース情報の引き継ぎ**
   - 元のカードのトレース接続を統合後カードに付け替え
   - 重複するトレースは統合

3. **履歴記録**
   - 統合操作を履歴に記録
   - Undo/Redo可能

---

## 12. Markdown Table表記対応

### 12.1 概要
カード内容にMarkdown形式のテーブルを記述し、プレビュー表示する機能。

### 12.2 画面構成

#### 12.2.1 Markdownテーブルの入力

**編集モード:**
```
┌─────────────────────────────┐
│ ● 📊 [Draft] TABLE-001       ●│
│                               │
│ | 項目 | 内容 | 備考 |         │
│ |------|------|------|        │
│ | A    | 100  | 正常 |         │
│ | B    | 200  | 正常 |         │
│ | C    | 300  | 異常 |         │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
```

**プレビューモード (MDボタンON時):**
```
┌─────────────────────────────┐
│ ● 📊 [Draft] TABLE-001   [MD]●│
│                               │
│ ┌───────┬──────┬──────┐     │
│ │ 項目  │ 内容 │ 備考 │     │
│ ├───────┼──────┼──────┤     │
│ │ A     │ 100  │ 正常 │     │
│ │ B     │ 200  │ 正常 │     │
│ │ C     │ 300  │ 異常 │     │
│ └───────┴──────┴──────┘     │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
```

#### 12.2.2 Markdownプレビュー設定

設定ビューに以下のオプションを追加：

```
┌────────────────────────────────────┐
│ Markdownプレビュー設定              │
│                                     │
│ ☑ Markdownプレビューを有効化        │
│ ☑ テーブル表記をサポート            │
│ ☑ コードブロックをハイライト        │
│ ☑ リンクを有効化                    │
│                                     │
│ プレビューテーマ:                  │
│ ○ GitHub風                         │
│ ○ シンプル                         │
│ ○ カスタム                         │
│                                     │
│              [保存] [キャンセル]    │
└────────────────────────────────────┘
```

---

## 13. LLM機能の拡張

### 13.1 概要
段落分割判別やグラフRAG向けの要約機能をLLM機能に追加。

### 13.2 画面構成

#### 13.2.1 LLM設定の拡張

設定ビューのLLMセクションに以下を追加：

```
┌────────────────────────────────────┐
│ LLM設定                             │
│                                     │
│ 基本設定                           │
│ ──────────────────────────────── │
│ プロバイダ: [OpenAI ▾]             │
│ モデル:     [gpt-4 ▾]              │
│ APIキー:    [******************]   │
│ Temperature: [0.0]                 │
│                                     │
│ 機能設定                           │
│ ──────────────────────────────── │
│                                     │
│ ☑ カード変換 (既存機能)             │
│                                     │
│ ☑ 段落分割判別                      │
│   段落分割の閾値: [0.7]            │
│   (高いほど分割されにくい)          │
│                                     │
│ ☑ グラフRAG要約                     │
│   要約の最大文字数: [200]          │
│   要約の粒度:                      │
│   ○ 高レベル (概要のみ)            │
│   ○ 中レベル (主要ポイント)        │
│   ○ 低レベル (詳細含む)            │
│                                     │
│              [保存] [キャンセル]    │
└────────────────────────────────────┘
```

#### 13.2.2 段落分割判別の適用

**変換ダイアログに追加:**
```
┌─────────────────────────────────────────────┐
│ ファイルを開く                              │
├─────────────────────────────────────────────┤
│                                              │
│ ファイルパス:                                │
│ [/workspace/spec.md                     ] [📂]│
│                                              │
│ 変換方法:                                    │
│ ○ 固定ルール (rule)                         │
│ ● LLM (llm)                                 │
│                                              │
│ LLMオプション:                               │
│ ☑ 段落分割判別を使用                         │
│   (LLMが段落の境界を自動判定)                │
│                                              │
│ ☑ 要約を生成                                 │
│   (カード毎に要約文を生成)                   │
│                                              │
│                          [変換] [キャンセル] │
└─────────────────────────────────────────────┘
```

#### 13.2.3 要約の表示

**カード表示に要約フィールドを追加:**
```
┌─────────────────────────────┐
│ ● 📑 [Draft] SPEC-001    [🤖]●│ ← 要約生成済みアイコン
│                               │
│ 要件定義                      │
│                               │
│ [要約を表示 ▾]                │
│ ┌─────────────────────────┐ │
│ │ 📝 AI要約:                │ │
│ │ この要件では、データベース│ │
│ │ 設計とAPI設計に関する基本 │ │
│ │ 方針を定めています。       │ │
│ └─────────────────────────┘ │
│                               │
│ 最終更新: 2025-10-19 14:30   │
└─────────────────────────────┘
```

**要約の利用シーン:**
- 検索時のスニペット表示
- エクスポート時のサマリー生成
- グラフRAGのノード情報

---

## 14. まとめ

本ドキュメントでは、以下の13の将来機能について画面モックアップを作成しました：

1. **プロジェクトファイル機能** - プロジェクト管理ダイアログ、プロジェクトファイル仕様
2. **トレースのマトリクス編集機能** - マトリクス編集ダイアログ、フィルタ機能
3. **影響分析のヒートマップ表示** - ヒートマップ表示モード、凡例、設定
4. **ID自動付与と接頭語指定機能** - 変換ダイアログの拡張、ID表示
5. **未トレースカード数表示** - ツールバーの拡張、フィルタ表示
6. **右クリックコンテキストメニュー** - コンテキストメニュー、統計情報ダイアログ
7. **検索機能の改善** - 検索ダイアログ、高度な検索（クエリビルダー）
8. **カード履歴管理機能** - カード履歴表示、履歴ファイル仕様
9. **カード出力機能** - エクスポートダイアログ、影響範囲分析、ナレッジグラフ出力
10. **廃止ステータスの追加** - 廃止ステータス表示、制約
11. **カード統合機能** - 統合ダイアログ、統合処理
12. **Markdown Table表記対応** - テーブルプレビュー、設定
13. **LLM機能の拡張** - 段落分割判別、グラフRAG要約

これらの機能は、現在の画面設計（`user_interface_design.md`）のデザイン原則を踏襲し、一貫性のあるUIを実現しています。

---

**作成日**: 2025-10-19
**バージョン**: 1.0
**作成者**: Claude (Anthropic)
