# カード編集アプリケーション - UI画面設計書

## 1. 設計コンセプト

### 1.1 デザインフィロソフィー

本アプリケーションは、大規模プロジェクトにおける非構造化データの構造化とトレーサビリティ管理を実現するため、以下のデザインコンセプトに基づいて設計されています。

**主要コンセプト:**
- **視認性の高さ**: 情報の階層構造とトレーサビリティを直感的に理解できる視覚表現
- **操作効率**: キーボードショートカット、ドラッグ&ドロップ、マルチパネル編集による高速作業
- **情報密度の最適化**: コンパクト/詳細表示の切替により、状況に応じた情報密度を実現
- **モダンなルック&フィール**: シンプルで洗練されたデザイン、ライト/ダークモード対応

### 1.2 カラーパレット

Tailwind CSS のスレート/ブルー系スケールを基準とし、ライト/ダーク両モードで統一感のある配色を維持する。

**ライトモード:**
- 背景: `#F8FAFC`（Slate 50）
- サブ背景: `#FFFFFF`
- 境界線: `#E2E8F0`（Slate 200）
- テキスト: `#1E293B`（Slate 800）
- アクセント: `#3B82F6`（Blue 500）

**ダークモード:**
- 背景: `#020617`（Slate 950）
- サブ背景: `#0F172A`（Slate 900）
- 境界線: `#1E293B`（Slate 800）
- テキスト: `#E2E8F0`（Slate 200）
- アクセント: `#60A5FA`（Blue 400）

**ステータスバッジ:**
- Approved（承認済み）: ライト `bg-emerald-100` / `text-emerald-600`、ダーク `bg-emerald-500/20` / `text-emerald-300`
- Review（レビュー中）: ライト `bg-amber-100` / `text-amber-600`、ダーク `bg-amber-500/20` / `text-amber-200`
- Draft（下書き）: ライト `bg-slate-200` / `text-slate-600`、ダーク `bg-slate-600/30` / `text-slate-200`
- Deprecated（廃止）: ライト `bg-rose-100` / `text-rose-600`、ダーク `bg-rose-500/20` / `text-rose-200`

**テーマ切替:**
- グローバルツールバーに配置した「☀️ / 🌙」ボタンでモードをトグルし、`html.dark` クラスを切り替えることで全コンポーネントへ適用する。

### 1.3 タイポグラフィ

- 基本テキストサイズ: 0.875rem（Tailwind `text-sm`）
- UI コントロール（ボタン/バッジ）: 0.75rem 〜 0.65rem
- ログ・ステータス表示: 0.7rem 以下で表示密度を高める
- 行間は 1.5 を上限に抑え、余白より情報量を優先する

## 2. レイアウト構成

### 2.1 全体構造

アプリケーションは以下の5つの主要エリアで構成されています:

"""
┌────────────────────┐
│ メニューバー (Menu Bar)                │
├────────────────────┤
│ ツールバー (Tool Bar)                  │
├─────┬──────────────┤
│          │                            │
│サイドバー│                            │
│          │  カードパネルエリア        │
│          │  (カード一覧)              │
│          │                            │
│          │                            │
│          ├──────────────┤
│          │ ログエリア (Log Area)      │
├─────┴──────────────┤
│ ステータスバー (Status Bar)            │
└────────────────────┘
"""

カードパネルエリアは、左右方向、上下方向に、スプリット操作履歴に基づく再帰的グリッド構造とする。(VSCodeのような分割の考え方)。分割されたグリッドを分割ノードと称する。
初期状態では単一の分割ノードである。ユーザが左右/上下分割操作で左右分割、上下分割となる。
分割ノードの領域は、領域境界をドラッグアンドドロップすることで任意のサイズに変更可能とする。
つまり左右分割した縦境界をドラッグアンドドロップで左右のパネルのサイズを変更可能とし、上下分割した横境界をドラッグアンドドロップで上下のパネルのサイズを変更可能とする。
分割ノードは閉じる操作により統合でる。分割履歴は undo/redo の対象とする。

１つの分割ノードには以下の「タブバー＋カードパネル」が表示される。
「タブバー＋カードパネル」にはタブによって、カードパネルを切り替えることができる。

"""
┌────────────┐
│ タブバー (Tab Bar)     │
├────────────┤
│                        │
│                        │
│  カードパネル          │
│                        │
│                        │
└────────────┘
"""

カードパネルには、以下のエリアが表示される。
"""
┌────────────┐
│ ツールバー (Tool Bar)  │  ← 固定表示
├────────────┤
│                        │
│                        │
│  カード一覧            │  ← 独立した垂直スクロール
│  (垂直スクロール)      │     カード数が多い場合のみ
│                        │     スクロールバーを表示
└────────────┘
"""

**スクロール仕様:**
- カード一覧領域のみが独立してスクロール可能（`overflow-y: auto`）
- タブバーとツールバーは常に画面上部に固定表示（`flex-shrink-0`）
- カード数が多い場合でも、ツールバーやログエリアが画面外に押し出されることはない


### 2.2 寸法と比率

- **メニューバー**: 高さ 28px
- **ツールバー**: 高さ 36px
- **サイドバー**: 幅 240px（可変リサイズ可能・最小 180px）
- **タブバー**: 高さ 36px
- **ログエリア**: 高さ 112px（可変リサイズ可能・最小 80px）
- **ステータスバー**: 高さ 22px
- **カードパネルエリア**: 残りのスペースを均等分割（可変リサイズ可能）

## 3. コンポーネント詳細

### 3.1 メニューバー

**構成要素:**
- ファイル(F): ファイルを開く(O)、上書き保存、別名保存、終了
- 編集(E): Undo、Redo、設定
- 表示(V): エクスプローラ、検索/置換、各パネル表示切替
- ヘルプ(H): 操作方法、バージョン情報

**デザイン特徴:**
- OSネイティブのメニューバースタイルを踏襲
- ホバー時に背景色を変更してフィードバック
- アクセスキー（F, E, V, H）を表示
- **共通ボタン方針:** 画面上に表示されるボタンは可能な限りアイコンのみを表示し、ラベル文は `title` 属性によるツールチップで提示する。横幅を圧迫しないための設計指針であり、マウスオーバー時に日本語の説明がポップアップする。

### 3.2 ツールバー

**構成要素（左から右へ）:**

1. **ファイル操作グループ** (左寄せ)
   - ファイルを開く (📂アイコン) ※テキスト（`.txt`, `.md`）を読み込む。
   - 保存 (💾アイコン)
   - 別名保存 (📝アイコン)

2. **トレーサビリティグループ** (左寄せ)
   - トレース👉作成 (➡️アイコン) 
   - トレース👈作成 (⬅️アイコン) 
   - トレース⇔作成 (↔️アイコン)  
   - トレース作成のトレース関係種別(ドロップダウンとしいづれか1つを必ず選択)
   - トレース削除 (💔アイコン)
   - トレース表示ミュート (⛓️アイコン) ※トグルボタン、全カードパネル共通設定
   - トレース強調の還流許可 (🔁アイコン) ※トグルボタン。ON の場合はトレーサビリティ経路のうち自パネルに還流したカードを除外し、他パネルのみ強調表示する。OFF の場合は自パネルにも還流して強調する。
   - トレース種別表示フィルタ (🧬アイコン)(ドロップダウンとし、それぞれON/OFF選択可能とする)
   - ステータスフィルタ (🔄アイコン) ※選択中カードのステータスを循環

3. **パネル分割グループ** (左寄せ)
   - 左右分割
   - 上下分割

4. **テーマ切替グループ** (右端配置)
   - テーマ切替 (☀️/🌙 アイコン) ※クリックでライト/ダークモードをトグル

**デザイン特徴:**
- アイコンサイズ: 20×20px
- ボタンパディング: 8px
- グループ間の区切り線で視覚的にセクション分け
- トグルボタンはアクティブ時にブルー背景
- テーマ切替は Tailwind の `html.dark` 切替と連動し、クリック時にログへ記録される

### 3.3 サイドバー
*エクスプローラ*と*検索/置換*からなる、上下の折畳パネルとする。

**共通仕様**
- セクションヘッダーはトグルボタン（`▾`/`▸`）として機能し、クリックで表示/非表示を切替える。
- 折畳時は内容が非表示になり、`aria-expanded` と `aria-controls` によりアクセシビリティを担保する。
- 検索パネルは常にエクスプローラの直下へ配置され、エクスプローラを折りたたんだ場合も上詰めで表示される。
- 検索パネルは境界線で区切り、折畳時も上部ボーダーは維持する。

**エクスプローラ**
- フォルダ・ファイルツリー形式でカードファイルを一覧表示
- フォルダには以下の情報を表示:
  - フォルダ (📁)
  - フォルダ名
- 各ファイルには以下の情報を表示:
  - アイコン (📄)
  - ファイル名
  - 未保存マーカー (●、オレンジ色)
- ホバー時に背景色変更
- 選択中ファイルは背景色を青系に変更

**検索/置換**
- 検索テキストボックス
- 検索アイコン (🔍) を左側に配置
- フォーカス時にブルーのリングを表示

**デザイン特徴:**
- 背景色: グレー50 (ライトモード)
- 境界線: 右側に1pxの境界線
- リサイズハンドル（境界線上でカーソル変更）

### 3.5 カードパネルエリア

左右方向、上下方向に、スプリット操作履歴に基づく再帰的グリッド構造とする。(VSCodeのような分割の考え方)。
分割サイズは任意に変更可能とする。
分割ノードに、複数のカードパネルを配置可能とする。

### 3.6 分割ノード

#### 3.6.1 タブバー

**構成要素:**
- 開いているファイルごとにタブを表示
- タブには以下を含む:
  - ファイルアイコン (📄)
  - ファイル名
  - 未保存インジケータ (●、オレンジ色)
  - 閉じるボタン (×) (マウスオーバ時のみ)
- 右端に新規タブボタン (➕)

**デザイン特徴:**
- アクティブタブ: 白背景、下部境界線なし
- 非アクティブタブ: グレー背景、ホバー時に明るく
- タブ幅: 最大200px、最小100px
- タブは横スクロール可能

#### 3.6.2 カードパネル

カードパネルを表示する。

- **アクティブパネル表示**: 現在選択中の分割ノードはパネル外枠を青色のハイライトリングとシャドウで強調し、他パネルより前景に浮かび上がらせる。ハイライトは `split-node--active` クラスで制御し、クリックまたはショートカットでフォーカスが移動したタイミングで即座に更新される。

### 3.5 カードパネル

#### 3.5.1 ツールバー

**構成要素（左から右へ）:**
全てアイコン表示とする。ボタンマウスオーバで説明文字表示。

1. **表示操作グループ**
   - 展開 (⏬アイコン)
   - 折畳 (⏫アイコン)

2. **表示フィルタグループ**
   - 文字列フィルタ(👓アイコン)
   - カード種別情報フィルタ (📚アイコン)(ドロップダウン表示し、カード種別情報毎にチェックボックスON/OFF)

3. **コネクタグループ**
   - トレース表示ミュート (⛓️アイコン) ※トグルボタン、当該カードファイルカードに全カード対するコネクタ表示有無を切り替える。

4. **表示モードグループ**
   - コンパクト表示 (☰アイコン) ※トグルボタン

**デザイン特徴:**
- アイコンサイズ: 20×20px
- ボタンパディング: 8px
- グループ間の区切り線で視覚的にセクション分け。すべて左寄せで配置
- トグルボタンはアクティブ時にブルー背景
- 右端にカード層数（例: `カード総数: 3`）を表示し、ツールバーの情報として集約

#### 3.5.2 カード一覧

**スクロール挙動:**
- カード一覧領域はカードパネル内で独立したスクロールコンテナ（`overflow-y: auto`）
- カード数が多い場合、カード一覧のみが垂直スクロールバーを表示
- タブバー、ツールバー、ログエリアは常に画面上に固定表示され、スクロールしても隠れない
- これにより大量のカードが存在してもカードパネル全体や周辺レイアウトをスクロールさせず、トレーサビリティコネクタのレイアウト基準（カード位置との同期）を維持したまま下部カードへアクセスできる
- スクロール時、トレーサビリティコネクタの座標も自動的に再計測される

##### 3.5.2.1 カード表示

**カード構造（詳細表示モード）:**

"""
┌─────────────────────────┐
│ ● [アイコン] [Status Badge]                 ●  │
│                                                  │
│   カードの内容テキスト(テキストボックス)         │
│                                                  │
│   最終更新: 2025-10-19 14:30                     │
└─────────────────────────┘
"""

**要素詳細:**

1. **トレース接合点（●）**
   - 位置: カードの左端と右端
   - サイズ: 18×18px
   - 状態:
     - 塗りつぶし (●): トレース関係あり、ライト `text-blue-400` / ダーク `text-blue-300`
     - 白抜き (○): トレース関係なし、ライト `text-slate-400` / ダーク `text-slate-600`
   - "トレース関係あり"は、トレーサビリティ情報ファイルが読み込まれたのち、当カードにトレース情報がある場合に●とする。
   - 当カードと関連するトレース情報の数をトレース接合点の右上に"数字付バッジ"として表示する。
- トレース接合点が●の状態の場合、●をクリックすることで当該カードのコネクタ表示の有無を切り替える。視覚的にも色でわかるようにする。

##### 3.5.2.2 カード選択状態とパネル状態

- カードパネルは「アクティブ」「準アクティブ」「非アクティブ」の3状態を持ち、背景や枠線で区別する。
  - **アクティブ**: 直近で操作されたカードパネル。`split-node--active`（青系）で表示。
  - **準アクティブ**: Ctrl+クリックで別パネルを選択した際に直前までアクティブだったパネル。`split-node--semi-active`（アンバー系）で表示し、以降の Ctrl 操作で複数保持できる。
  - **非アクティブ**: 上記以外のパネル。通常枠。
- パネル内のカード選択も 3 つの状態を持ち、スタイルをカスタマイズ可能とする。
  1. **選択パネル選択カード状態**: アクティブパネル内で選択されたカード。`card--selected-primary` を適用し、青系の太い左ボーダーで強調。
  2. **準選択パネル選択カード状態**: 準アクティブパネル内で選択されたカード。`card--selected-secondary` を適用し、アンバー系のボーダーで表示。
  3. **非選択パネル選択カード状態**: 非アクティブパネル内の選択カード。`card--selected-inactive` で淡色表示。
- クリック種別による状態遷移:
  - 通常クリック/Shift+クリック: 直前アクティブパネルは「非アクティブ」に、クリック先パネルを「アクティブ」に遷移。
  - Ctrl+クリック: 直前アクティブパネルを「準アクティブ」に保ちつつ、クリック先パネルを「アクティブ」に遷移（複数保持可）。
- トレーサビリティ経路に存在するカードは `card--trace-related` で常時ハイライトし、接続コネクタも太線＋ `--trace-highlight-color` で強調する。
- `🔁`（トレース強調の還流許可）が ON の場合、トレーサビリティ経路が自パネルへ戻ってきた際は、選択中カードを除き自パネル側を強調対象から除外する。OFF の場合は従来どおり自パネルを含めて強調する。

2. **展開/折りたたみボタン**
   - 子カードがある場合のみ表示
   - アイコン: ⏭️（展開）/ ⏮️（折りたたみ）
   - サイズ: 16×16px

3. **カード情報種別アイコン**
   - 見出し (heading): 📑
   - 段落 (paragraph): 📝
   - 箇条書き (bullet): •
   - 図 (figure): 🖼️
   - 表 (table): 📊
   - 試験 (test): 🧪
   - QA (qa): 💬

4. **ステータスバッジ**
   - サイズ: 自動幅、高さ 18px
   - 角丸: 12px（完全な角丸）
   - テキスト: 大文字、10px
   - パディング: 左右6px、上下2px

5. **カード内容**
   - テキストボックス（編集可能）
   - フォントサイズ: 12px
   - 行高: 1.5
   - カラー: グレー900

6. **最終更新時刻**
   - フォントサイズ: 10px
   - カラー: グレー500
   - マージン上部: 4px

**カード構造（コンパクト表示モード）:**

"""
┌────────────────────────┐
│ ● [アイコン] [Status] カード内容の1行目... ● │
└────────────────────────┘
"""

- 高さ: 1行分（約32px）
- 内容は1行で切り詰め（truncate）

#### 3.5.3 階層表示

**インデント:**
- レベル0（ルート）: インデント 12px
- レベル1: インデント 36px（+24px）
- レベル2: インデント 60px（+24px）
- レベルN: インデント 12 + (N × 24)px

**視覚表現:**
- 階層ごとにインデントを追加
- 折りたたみ可能なノードには展開/折りたたみボタンを表示
- 親カードが折りたたまれた場合、子カードは非表示

#### 3.5.4 選択状態

**単一選択:**
- ライトモード: 背景 `bg-blue-50/70`、左境界線 4px `border-blue-500`
- ダークモード: 背景 `bg-slate-800/80`、左境界線 4px `border-blue-500`
- `shadow-md` 程度の影で強調

**複数選択（CTRL/SHIFT）:**
- 単一選択スタイルを複数カードへ適用（擬似的ハイライト）

**選択解除:**
- カードパネル内でカード以外（空白領域や「表示するカードがありません」メッセージなど）をクリックすると、そのパネル内の選択状態を即座にクリアする。

**ホバー状態:**
- ライトモード: 背景 `hover:bg-blue-100`
- ダークモード: 背景 `hover:bg-slate-800`
- トランジション: 0.15s ease-out
- キーボードフォーカス時は `outline-blue-500` のフォーカスリングを描画

### 3.6 トレーサビリティコネクタ

- 選択中パネルの選択中カードとトレーサビリティ関係のあるコネクタ、他パネルのカードは強調表示する。
- 複数カードパネルが拓いており、トレーサビリティ関係が数珠繋ぎとなる場合は、そのコネクタおよびカードに対して強調表示する。 

**視覚表現:**

1. **コネクタライン**
   - SVG要素等実現可能、かつカード位置に追従するコネクタとして描画
   - ストローク幅: 2px
   - カラー: ブルー500
   - 透明度: 0.6

2. **方向性の表現**
   - 片方向: 矢印 (→)
   - 双方向: 両矢印 (↔)
   - 無方向: 矢印なし (—)

3. **関係性の種類**
   - trace（トレース）: 実線
   - refines（詳細化）: 実線
   - tests（テスト）: 実線
   - duplicates（重複）: 実線
   - satisfy（要求満足）: 実線
   - relate（関係）: 実線
   - specialize（特化）: 実線

4. **インタラクティブ動作**
   - ホバー時: 透明度 1.0、ストローク幅 3px
   - 選択時: カラーをオレンジに変更

**コネクタの配置:**
- 左右分割された隣り合った左右のパネルに対し、左パネルのカードの右端トレース接合点から、右パネルのカードの左端トレース接合点へ
- Bézier曲線を使用して自然な曲線を描画
- 分割パネルが存在する場合、双方のカードビューに仮データを用いたコネクタ描画を行い、分割 UI の実現可能性を検証する。フェーズ3に先立ち、スタブデータによるコネクタ表示を準備する。

### 3.7 ログエリア

**構成:**

1. **ヘッダー**
   - 「動作ログ」タイトル（左側）
   - 「クリア」ボタン（右側）
   - 背景: ライト `bg-white`、ダーク `bg-slate-900`
   - クリアボタン: ライト `bg-rose-100`、ダーク `bg-rose-500/20`

2. **ログ表示エリア**
   - 等幅フォント（Fira Code 系）
   - フォントサイズ: 11px
   - 背景: ライト `bg-slate-50`、ダーク `bg-slate-950`
   - スクロール可能・リアルタイム追加

3. **ログ表示スタイル**
   - ログレベルはテキスト冒頭のプレフィックスで区別（色分けは行わない）
   - 行末で自動的に改行を挿入

4. **ログリセット挙動**
   - 「クリア」操作でログを初期化し、新しい INFO ログを1件だけ残す

**ログフォーマット:**
"""
[YYYY-MM-DD HH:MM:SS] LEVEL: メッセージ内容
"""

### 3.8 ステータスバー

**左側グループ:**
- 総カード数
- 選択中のカード番号
- 保存状態インジケータ
  - ✓ 保存済み（グリーン）
  - ● 未保存（オレンジ）

**右側グループ:**
- 文字コード（例: UTF-8）
- テーマモード（ライト/ダークの表示名）

**デザイン特徴:**
- フォントサイズ: 10px 相当（Tailwind `text-[0.65rem]`）
- 背景: ライト `bg-slate-100`、ダーク `bg-slate-900`
- 境界線: 上部に1px
- 高さ: 22px
- テーマ情報はツールバー操作と即時連動し、現在モードを文字列で表示

### 3.9 設定ビュー

**アクセス経路:**
- メニューバーの「編集(E) > 設定」を選択、または `Ctrl+,` のショートカットでモーダルを開く。分割パネル状態に影響せずアプリ全体にオーバーレイ表示する。
- 実装ではメニューバー「編集」ボタンと `Ctrl+,` の両方を受け付け、モーダル外クリックまたは `Esc` で閉じる。

**レイアウト:**
- 左側: セクションリスト（テーマ / 入出力 / ログ / ワークスペース）。
- 右側: 選択されたセクションの詳細フォームを表示。各セクションは `保存` / `キャンセル` ボタンを共通フッターに配置。
- モーダル幅 640px、最大高さ 70vh。スクロール時はヘッダー/フッターを固定。

**項目例:**
- テーマ: ラジオボタン（ライト / ダーク / システム）。プレビューとしてサムネイル切替を表示。
- 入出力: 警告サイズ/中断サイズ（MB）、改行正規化（トグル）、エンコーディングフォールバック（ドロップダウン）。
- ログ: ログレベル（セレクト）、ローテーションサイズ/世代数。
- ワークスペース: 最近開いたファイル一覧、履歴クリアボタン、ワークスペースフォルダのパス表示＆開くボタン。

**挙動:**
- `保存` 時に `window.app.settings.update` を呼び出し、成功後にモーダルを閉じてトースト通知を表示。`キャンセル` または `Esc` で変更を破棄し閉じる。
- 入力エラー（数値範囲、必須値）はそのフィールド直下にエラーメッセージを表示し、保存を抑止する。
- 設定変更は即時にストアへ反映される設計とし、テーマ切替や分割幅は保存前でも即時プレビューされる（ただし保存しない場合はモーダルを閉じると元に戻る）。

### 3.10 通知コンポーネント

**概要:**
- 画面右上に表示するトースト通知。成功/警告/エラーなど共通フィードバックを提供し、どの機能からでも利用できる。

**表示ルール:**
- 表示位置: 右上マージン 16px。最大5件まで縦に積んで表示。
- レベル別スタイル: `info`/`success`/`warning`/`error` を色とアイコンで区別。
- 既定表示時間 4 秒。手動で閉じる `×` ボタンを右端に配置。
- `aria-live="polite"` でスクリーンリーダーへ通知。

**主な発火シナリオ:**
- 設定保存成功/失敗、ファイル入出力エラー、カード操作の完了通知。
- 通知発火時は `window.app.log` を通じてファイルログにも同一メッセージを出力し、監査要件を担保する。

## 4. インタラクション設計

### 4.1 カード操作

#### 4.1.1 選択
- **単一選択**: クリック
- **複数選択（離散）**: CTRL + クリック
- **複数選択（連続）**: SHIFT + クリック
- **全選択**: CTRL + A

#### 4.1.2 移動
- **ドラッグ&ドロップ**: カードをドラッグして移動
- **視覚フィードバック**:
  - ドラッグ中: カードを半透明化（opacity: 0.5）
  - ドロップ先: 青色の挿入線を表示
  - コピー/貼り付け操作でも同一の挿入線と枠線を表示し、貼り付けたカードは約1.2秒間ハイライトする
  - ホバー: カーソルを「move」に変更

#### 4.1.3 展開/折りたたみ
- **ボタンクリック**: 展開/折りたたみボタンをクリック
- **ダブルクリック**: カード自体をダブルクリック
- **キーボード**: 選択中カードに対して
  - 右矢印 (→): 展開
  - 左矢印 (←): 折りたたみ

#### 4.1.4 編集
- **内容編集**: カードをダブルクリックで編集モードに
- **ステータス変更**: ステータスバッジをクリックでドロップダウン表示
- **複数カード編集**: 複数選択時、共通プロパティを一括編集可能

#### 4.1.5 コピー/ペースト
- **コピー**: ツールバーの「📋 コピー」ボタン、または `CTRL + C`。複数選択時は最上位カードのみをコピーし、子孫カードは自動的に含める。
- **ペースト**: ツールバーの「📥 ペースト」ボタン、`CTRL + V`、右クリックメニュー（前/後/子として貼り付け）から選択。貼り付け位置は挿入モード設定（前/後/子）に従い、ドロップゾーンを青い挿入線と枠線で強調する。
- **ハイライト**: 貼り付け直後のカードは 1.2 秒間淡いブルーでハイライトされ、挿入位置を明示する。
- **Undo/Redo**: 貼り付け操作は Undo/Redo スタックに記録され、取り消し/やり直しが可能。

#### 4.1.6 ドラッグ移動プレビュー
- **兄弟挿入**: ドラッグ中にカード間へ近づくと 1 本のラインと「ここに挿入（前/後）」バッジを表示し、どちら側へ差し込まれるか即座に判断できるようにする。
- **子挿入**: 子としてドロップできる領域では対象カード全体を淡いオーバーレイで包み、「子として追加」ラベルを中央に表示して階層変更を示す。
- **視覚一貫性**: ラベルは 0.75rem のカプセルチップで表現し、ライト/ダーク両テーマに対応した配色（青系）とする。

### 4.2 トレーサビリティ操作

#### 4.2.1 コネクタ作成
1. カードの接合点をマウスダウン
2. 対象カードの接合点までドラッグ
3. マウスアップで接続確定
4. コネクタのプロパティダイアログ表示

#### 4.2.2 コネクタ編集
- **端点移動**: コネクタの端をドラッグ
- **削除**: コネクタを選択してDELETEキー
- **プロパティ変更**: コネクタを右クリック

#### 4.2.3 トレース強調表示
- カード選択時、関連するすべてのコネクタとカードをハイライト
- ハイライト色: オレンジ400
- 非関連要素: 透明度を下げる（opacity: 0.3）

### 4.3 キーボードショートカット

**ファイル操作:**
- CTRL + O: ファイルを開く
- CTRL + S: 上書き保存
- CTRL + SHIFT + S: 別名保存

**編集操作:**
- CTRL + Z: Undo
- CTRL + Y / CTRL + SHIFT + Z: Redo
- CTRL + C: コピー
- CTRL + X: カット
- CTRL + V: ペースト
- DELETE: 削除

**表示操作:**
- CTRL + F: 検索
- CTRL + H: 置換
- CTRL + B: サイドバー表示切替
- CTRL + L: ログエリア表示切替

**カード操作:**
- ↑↓: カード選択移動
- →: 展開
- ←: 折りたたみ
- CTRL + ↑↓: カード移動
- ENTER: 編集モードに

**表示モード:**
- CTRL + 1: 詳細表示
- CTRL + 2: コンパクト表示
- CTRL + T: トレース表示ミュート

## 5. レスポンシブ対応

### 5.1 ウィンドウサイズ対応

**最小ウィンドウサイズ:**
- 幅: 1024px
- 高さ: 768px

**推奨ウィンドウサイズ:**
- 幅: 1920px
- 高さ: 1080px

**リサイズ動作:**
- サイドバー、ログエリアは可変サイズ
- カードパネルは均等分割（可変）
- メニューバー、ツールバー、ステータスバーは固定

### 5.2 分割パネル

**分割方向:**
- 上下分割: 左右に最大4分割
- 左右分割: 上下に最大4分割
- 組み合わせ: グリッドレイアウト（最大16パネル）

**リサイズ:**
- パネル間の境界線をドラッグしてリサイズ
- 最小パネルサイズ: 200px × 200px

## 6. アニメーション

### 6.1 トランジション

**要素表示:**
- スライドイン: 0.2s ease-out
- フェードイン: 0.15s ease-in

**ホバー効果:**
- 背景色変更: 0.15s ease-out
- ボタンスケール: 0.1s ease-in-out

**カード展開/折りたたみ:**
- 高さアニメーション: 0.2s ease-in-out

### 6.2 マイクロインタラクション

**ボタン:**
- クリック時: スケール 0.95（0.1s）
- ホバー時: 背景色変更（0.15s）

**カード:**
- ドラッグ時: リフト効果（box-shadow）
- ドロップ時: バウンス効果（0.3s ease-out）

**コネクタ:**
- ホバー時: 太さ変更（0.2s）
- 選択時: カラー変更（0.15s）

## 7. アクセシビリティ

### 7.1 カラーコントラスト

**WCAG 2.1 AAレベル準拠:**
- テキストとバックグラウンドのコントラスト比: 最小4.5:1
- 大きいテキスト（18pt以上）: 最小3:1
- UIコンポーネント: 最小3:1

### 7.2 キーボードナビゲーション

**フォーカス表示:**
- フォーカスリング: 2px、ブルー500
- フォーカス可能な全要素に適用

**タブオーダー:**
1. メニューバー
2. ツールバー
3. サイドバー
4. カードパネル
5. ログエリア

### 7.3 スクリーンリーダー対応

- すべてのインタラクティブ要素にaria-label設定
- 階層構造にaria-level設定
- ライブリージョン（ログエリア）にaria-live設定

## 8. パフォーマンス最適化

### 8.1 仮想スクロール

**大量カード表示:**
- 表示範囲外のカードはDOM非生成
- スクロール時に動的に生成/破棄
- バッファ: 上下各10カード

### 8.2 遅延ロード

**画像/図表:**
- 表示範囲内に入った時点でロード
- サムネイル→高解像度の段階的ロード

### 8.3 最適化技術

**React最適化:**
- memo化: React.memo使用
- コールバック最適化: useCallback使用
- 不要な再レンダリング防止: useMemo使用

**レンダリング最適化:**
- リスト: key属性による差分検出
- 仮想スクロール: react-window使用
- コネクタ: Canvas APIまたはSVG最適化

## 9. 実装技術スタック

### 9.1 フレームワーク/ライブラリ

**コア:**
- Electron: デスクトップアプリフレームワーク
- React 18: UIライブラリ
- TypeScript: 型安全な開発

**UI/スタイリング:**
- Tailwind CSS: ユーティリティファーストCSS
- Lucide React: アイコンライブラリ

**状態管理:**
- Zustand または Redux Toolkit: グローバル状態管理
- React Context: ローカル状態管理

**その他:**
- react-window: 仮想スクロール
- react-dnd: ドラッグ&ドロップ
- react-split-pane: パネルリサイズ

### 9.2 ファイル構造

"""
src/
├── main/              # Electronメインプロセス
│   ├── index.ts
│   └── ipc/          # IPC通信
├── renderer/         # Reactレンダラープロセス
│   ├── components/   # UIコンポーネント
│   │   ├── MenuBar/
│   │   ├── ToolBar/
│   │   ├── Sidebar/
│   │   ├── CardPanel/
│   │   ├── Card/
│   │   ├── Connector/
│   │   ├── LogArea/
│   │   └── StatusBar/
│   ├── hooks/        # カスタムフック
│   ├── stores/       # 状態管理
│   ├── utils/        # ユーティリティ
│   └── App.tsx       # ルートコンポーネント
└── shared/           # 共有型定義
"""

## 10. 今後の拡張性

### 10.1 プラグインシステム

**カスタムカードタイプ:**
- プラグインによる新しいカード種別追加
- カスタムレンダラー登録

**カスタムコネクタスタイル:**
- プラグインによる新しいトレース関係追加
- カスタムビジュアライゼーション

### 10.2 テーマシステム

**カスタムテーマ:**
- JSONによるテーマ定義
- カラー、フォント、スペーシングのカスタマイズ
- テーマのインポート/エクスポート

### 10.3 コラボレーション機能（将来）

**リアルタイム編集:**
- WebSocketによる複数ユーザー編集
- 競合解決メカニズム
- カーソル位置の表示

---

**作成日**: 2025-10-19  
**バージョン**: 1.0  
**作成者**: Claude (Anthropic)
