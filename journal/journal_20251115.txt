# 作業記録 2025-11-15

## 作業概要
右クリックコンテキストメニューを専用コンポーネント化し、カード統計ダイアログとコピー系ユーティリティを実装。併せて `Card` モデルに `createdAt` を導入し、詳細設計書を更新。

## 実施内容
### 1. 右クリックメニュー/統計ダイアログの実装
- `src/renderer/components/ContextMenu.tsx:1-135` に汎用メニューコンポーネントを追加。表示位置補正と外側クリック/ESCクローズ、セクション/アイテムの Variant・Disable 判定を実装。
- `src/renderer/components/CardPanel.tsx:600-930` でコンテキストメニュー制御を刷新。`contextMenuSections` に編集/追加/貼り付け/情報セクションを構成し、`copyPlainText`・`handleCopyCardsAsText`・`handleCopyCardUuid` でカード本文/UUID コピーを提供。`CardStatsDialog` を開くハンドラや `statsTargetCardId` 管理も追加。
- `src/renderer/components/CardStatsDialog.tsx:1-120` に統計ダイアログを新設し、カードID/UUID/種別/ステータス/作成・更新日時/トレース件数/階層/文字数・単語数・行数を表示。
- `src/renderer/constants/cardPresentation.ts:1-46` でステータス/種別ラベルとアイコンを一元化し、`CardPanel`/`CardStatsDialog` 双方で利用。
- `src/renderer/utils/cardUtils.ts:1-57` に `CardContentStatistics` と `calculateCardContentStatistics` を実装、`src/renderer/utils/__tests__/cardUtils.test.ts:1-32` で単体テストを追加。
- `src/renderer/styles.css:513-548,1287-1345` へメニューのセクションラベル/アイコン/ショートカットと統計ダイアログのスタイルを追加し、ライト/ダークテーマで視認性を整えた。

### 2. データモデルと生成処理の拡張
- `src/shared/workspace.ts:60-140` に `Card` の `createdAt?: string` を追加し、`isWorkspaceSnapshot` で型チェックを拡張。
- `src/renderer/store/workspaceStore.ts:636-660,1764-1786` で `addCard` と `materializeClipboardNode` が `createdAt`/`updatedAt` を同一タイムスタンプで採番するよう更新。貼り付け生成カードにも反映。

### 3. ドキュメント更新
- `doc/software_detail_design.md:3` で最終更新日を 2025-11-15 に更新。
- 同ファイル `:314` に `createdAt` 追加と既存データの扱いを追記し、`:333-340` に P6-06（右クリックメニュー/統計ダイアログ拡張）の設計概要を追加。

## 次のアクション
- Jest ユニットテストを実行し、ContextMenu/統計機能追加後のリグレッションを確認する。
- カード右クリック時にメニューが即時クローズしていたため、`ContextMenu` の `contextmenu` リスナーを削除し、`mousedown` ベースの閉じ処理に統一した（WSL 環境含めて表示が安定）。
- フューチャー機能11「カード統合」を実装。`workspaceStore.mergeCards`（`src/renderer/store/workspaceStore.ts:600-760` 付近）で同一階層かつ連続するカードのみ統合可能とし、Undo/Redo と `dirtyCardIds` を更新。`CardPanel.tsx:830-1180` に 🧩 ボタン/コンテキストメニュー項目/モーダル表示を追加し、`CardMergeDialog.tsx` でタイトル・本文・カードID・オプションを編集できるUIを提供した。`CardPanel` 内の `reassignTracesForMerge` で `useTraceStore.saveRelationsForPair` を呼び出し、ロード済みトレースに限り left/right IDs を統合。`styles.css:1287-1350` に専用スタイル、`doc/software_detail_design.md` と `doc/implementation_plan_future_features.md` を更新、`workspaceStore.test.ts` に統合の単体テストを追加。

## 追加作業 (Phase0 トレースマトリクス準備)
- `src/shared/workspace.ts:33-140` で `CardStatus` に `deprecated` が含まれ、`Card` に `cardId` フィールドが存在することを確認。`src/shared/conversion/pipeline.ts:12-138` と `src/renderer/components/ConversionModal.tsx:191-304` でカードID自動付与UI/ロジックが揃っているため、Phase3.1の前提条件が満たされていると判断。
- `src/renderer/components/CardPanel.tsx:647-713,1906-1970` にてカードID一括接頭語変更/直接編集、`src/renderer/styles.css:868-887` にて `deprecated` バッジ配色、`src/renderer/components/CardPanel.tsx:505-512` にて未トレース集計から廃止カードを除外していることを確認。
- `src/renderer/store/traceStore.ts:1-386` を調査し、トレースファイルのロード/保存、関連カード集計API（`getRelatedCards`, `getCountsForFile` 等）が現在のカード一覧とコネクタ描画で利用可能になっている状況を整理。マトリクス専用の `getTraceMatrix` は未実装で追加が必要。
- `npm run test:unit` を実行したところ `src/renderer/store/workspaceStore.test.ts:779-834` で `mergeCandidates` 未定義や `result` 未初期化によるTypeScriptコンパイルエラーが発生し、スイート全体が停止。既存課題として記録（修正は未対応）。

## 次のアクション
- workspaceStoreのテストデータ定義を修正して`npm run test:unit`をパスさせる。
- TraceMatrix向けに`traceStore`へマトリクス取得APIを設計し、IPC/ストア整備(Phase1)に着手。

## Phase1着手ログ
- `src/renderer/store/workspaceStore.test.ts` の `mergeCards` テスト群で `mergeCandidates` が describe ブロック外から参照できず型推論も破綻していたため、テストデータをモジュールスコープに移動し、`WorkspaceStore['mergeCards']` 由来の `MergeCardsReturn` 型を導入。`npm run test:unit` が成功することを確認。
- `src/main/main.ts` / `src/main/preload.ts` を再確認し、現状IPCはメインウィンドウのみを対象に `workspace:*` / `history:*` / `document:*` などを expose していることを整理。マトリクス機能ではここに `matrix:open`/`matrix:close`/`trace:changed`/`card-selection:changed` を追加する必要がある。
- Phase1では `main/matrixWindowManager.ts`（BrowserWindow生成・ブロードキャスト管理）と `renderer/store/matrixStore.ts`（ウィンドウ状態＋IPCフック）を新設する方針で、既存 `traceStore` は `getTraceMatrix` 相当のデータ生成APIを拡張する計画。
- 実装済み: `src/main/matrixWindowManager.ts` と `matrix:open/close` IPC を追加し、preload/global.d.ts で `window.app.matrix` API を公開。`src/renderer/store/matrixStore.ts` と `src/renderer/hooks/useMatrixIPC.ts` で初期データロード・ハイライト更新・beforeunload時のクリーンアップを実装し、`npm run test:unit` でリグレッション確認済み。

## Phase2ログ
- `src/renderer/MatrixApp.tsx` と `src/renderer/main.tsx` を更新し、`#matrix` ウィンドウでは専用UIを描画するよう分離。`MatrixApp` 内で `useMatrixIPC` を起動し、ロード・エラー表示を担当。
- `TraceMatrixDialog/Header/Toolbar/Cell` を実装し、CSS Grid ベースの2Dグリッドで行/列ヘッダ・セル操作・統計バーを表示。セルクリックで `toggleTraceRelation`、右クリックで `TRACE_RELATION_KINDS` のコンテキストメニューを表示。
- `src/renderer/store/matrixStore.ts` にトレースファイル名/ヘッダ管理と stats 更新を追加し、`TraceMatrixDialog` から`window.app.workspace.saveTraceFile` + `window.app.matrix.broadcastTraceChange` を呼べるよう整備。`src/renderer/hooks/useMatrixIPC.ts` は `loadTraceFile` から得たメタ情報をストアへ反映。
- `src/renderer/utils/matrixRelations.ts` とJestテストを追加し、セル単位トグル/種別変更のロジックを単体テストで担保。
- `src/renderer/styles.css` にトレースマトリクス用スタイルを追加し、提示されたimage.pngのライトモード配色/セル色分けを再現。

## Phase3-5ログ
- Phase3: `matrixStore` にフィルタ状態と行/列ハイライトセットを追加し、`TraceMatrixFilterPanel.tsx` と `TraceMatrixDialog.tsx` にカードID/タイトル検索、ステータスチェック、行列トレース注目フィルタを実装。カードパネル側から `window.app.matrix.broadcastCardSelection` を送信し、マトリクスで行・列をハイライトできるようにした。
- Phase4: `matrixExport.ts` でCSV生成を実装し、`matrix:export` IPCで `_out` への保存を実現。Excel出力は `npm install xlsx@0.18.5` が DNSエラー（`EAI_AGAIN`）で失敗したため保留だが、CSVボタンからは即保存可能。
- Phase5: `CardPanel.tsx` でマトリクス選択イベントの送受信を実装し、Matrix→カード一覧→Matrix の双方向ハイライトを達成。マトリクス上のセル操作後に `broadcastTraceChange` でカード一覧のトレースキャッシュを更新する仕組みも動作確認済み。
