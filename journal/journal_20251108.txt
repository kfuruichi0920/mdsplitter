### カード一覧スクロール領域の再設計 (2025-11-08)
- 問題分析: ドキュメント指摘どおりカード一覧が独立スクロールになっておらず、画面全体がスクロールしていた。DOM階層を調査したところ、`workspace` -> `workspace__content` -> `panels` -> `SplitContainer` -> `split-node` の各レイヤーが `min-height: 0` や `overflow-hidden` を持たず、子要素の高さに引きずられて親コンテナ全体が伸長していることが原因と判明。単に `panel-cards` に CSS を当てるだけでは親要素が高さ制約を持たないため効果がなかった。
- 対策: レイアウトを根本から見直し、以下を実施。
  1. `workspace` / `workspace__content` / `panels` をすべて `overflow-hidden` + `h-full` + `flex` 化し、グリッド行の高さを固定したまま内部スクロールを許容。
  2. `panels__body` ラッパーを新設して `SplitContainer` 全体に `min-h-0`/`overflow-hidden` を適用し、カードパネル領域が常に自分のグリッドセル内に収まるようにした。
  3. `SplitContainer` 側では既存の `split-node`/`split-container` の `flex-1` 設定と組み合わせることで、各 `CardPanel` の `panel-cards` に設定済みの `overflow-y-auto` が正しく機能するようになった。
- これにより大量カードでもカード一覧だけに垂直スクロールが表示され、ツールバーやログエリアは固定表示のままとなる。

### タブバー「＋」からの新規カードファイル作成 (2025-11-09)
- `workspaceStore` に `fileName: string | null` と `createUntitledTab` を導入し、未保存タブは `fileName=null` かつ `title="新規ファイル n"`、`isDirty=true` で生成。`fileToLeaf` は実ファイルのみ追跡するよう `closeTab`/`closeLeaf` を調整し、保存時に `renameTabFile` が本来のファイル名を割り当てる（`src/renderer/store/workspaceStore.ts`）。
- `CardPanel` の「＋」ボタンを有効化し、クリックで `createUntitledTab` を呼び出して空タブを追加。ログへ操作を残し、未保存タブでもトレースアンカーが一意になるよう `fileName` フォールバックとしてタブIDを `CardListItem` に渡す（`src/renderer/components/CardPanel.tsx`）。
- `.tab-bar__tab--add` スタイルを更新してホバー/フォーカス時に視覚的なフィードバックを付与、未保存タブ追加操作が可能であることを強調（`src/renderer/styles.css`）。
- `workspaceStore.test.ts` へ未保存タブ生成テストを追加して連番タイトルの一意性と `fileToLeaf` 未登録を保証し、`doc/software_detail_design.md` と `task/task_all.md` に仕様反映を記録。

### 保存ダイアログ API への置き換え (2025-11-09)
- サンドボックス環境で `window.prompt` が使用できず保存時に例外が発生していたため、Electron の `dialog.showSaveDialog` を `dialog:promptSaveFile` IPC として公開（`src/main/main.ts`, `preload.ts`, `renderer/global.d.ts`）。
- `App.tsx` の `promptExportFileName` を非同期化し、新ダイアログ API を利用してファイル名を取得。キャンセル時は null を返し、失敗時のみトースト通知するように調整。
- `App.test.tsx` へ `promptSaveFile` のモックを追加し、既存テストが新APIで成功することを確認。

### P5-01〜P5-03 トレーサビリティ拡張 (2025-11-08)
- **データモデル/永続化 (P5-01)**: `src/shared/traceability.ts` にヘッダ構造・relation ID・リンク展開ユーティリティを追加し、`TraceabilityRelation` の型を本番仕様へ揃えた。`workspace.saveTraceFile` (`src/main/workspace.ts`) と IPC (`src/main/main.ts`, `src/main/preload.ts`, `src/renderer/global.d.ts`) を新設し、`src/main/__tests__/workspace.traceability.test.ts`/`src/shared/traceability.test.ts` で JSON 読み書きを検証。
- **コネクタ作成/削除 (P5-02)**: ツールバーに `➡️/⬅️/↔️/💔` を追加し (`src/renderer/App.tsx`)、アクティブな垂直分割ペアを `src/renderer/utils/traceLayout.ts` で解析。`useTraceStore.saveRelationsForPair` と `workspaceStore.setCardTraceFlags` (`src/renderer/store/workspaceStore.ts`) により relation 更新とカードの trace フラグ同期を自動化。`src/renderer/store/__tests__/traceStore.test.ts` で永続化パスをモック検証。
- **表示フィルタ (P5-03)**: `src/renderer/store/tracePreferenceStore.ts` を導入し、可視トグル・選択カード限定表示・種別チェックボックスを集中管理。`TraceConnectorLayer` が同ストアを参照してフィルタリングし、`App.tsx` の `🧬` ポップオーバー (CSS は `src/renderer/styles.css`) で UI を提供。`src/renderer/store/__tests__/tracePreferenceStore.test.ts` で設定ストアをテスト。

### P5-05〜P5-07 トレーサ強化 (2025-11-08)
- **種別選択 (P5-05)**: トレース作成ハンドラに relation ドロップダウンを追加し、`useTracePreferenceStore.creationRelationKind` で新規コネクタの `type` を決定。表示側は `🧬` ポップオーバーをチェックボックス構成へ改修し、`TraceConnectorLayer` が `enabledKinds` を参照して描画を制御。
- **パネル単位表示 (P5-06)**: `CardPanel` ツールバーへ `⛓️` トグルを実装し、アクティブファイルごとにコネクタ描画を ON/OFF。`tracePreferenceStore` に `fileVisibility` を持たせ、`TraceConnectorLayer` と接合点が同じ状態を共有する。
- **接合点拡張 (P5-07)**: カード左右の接合点をボタン化し、relation 数のバッジと個別ミュート操作を実現。`useTraceStore.aggregateCountsForFile` がカード別接続数を算出し、`tracePreferenceStore` の `toggleCardVisibility` が `TraceConnectorLayer` と `CardPanel` の双方に反映される。

### P5-04 選択カードフォーカス強調 (2025-11-08)
- `useTraceStore.getRelatedCards`/`getRelatedNodeKeys` を追加し、選択カードからトレーサ経路で到達可能なカード集合を算出。`TraceConnectorLayer` は nodeKey 単位でコネクタをハイライトし、`🔁` 還流許可トグル ON 時には自パネルへの還流を除外、OFF 時は従来どおり自パネルも含めて強調する。
- `CardPanel` 側では `panelEngagementStore` がパネル状態（アクティブ/準アクティブ/非アクティブ）を追跡し、カードは `card--selected-primary` / `card--selected-secondary` / `card--selected-inactive` の3クラスで表現。`card--trace-related` は常に数珠つなぎカードを強調し、接合点は件数付きボタン＋個別トグルへ刷新した。
- テーマ設定へ `relationColors`/`connectorHighlight` を追加し、CSS 変数 `--trace-color-*` / `--trace-highlight-color` 経由でトレース色をカスタマイズ可能にした。`styles.css` はこれら変数を参照するよう更新。
